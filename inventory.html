<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLK – Player Collection</title>
  
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--line:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .hdr{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .hdr h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;padding:12px 16px}
    .row .col-span-2{grid-column:span 2}
    .input,select{width:100%;background:#0b1220;border:1px solid #263042;color:var(--text);border-radius:10px;padding:10px;font-size:14px}
    .btn{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.alt{background:#334155}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:16px}
    .card{background:#0b1220;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .thumb{aspect-ratio:3/4;background:#060a12;display:block;width:100%;object-fit:cover}
    /* make controls compact */
    .toolbar .pill select,
    .toolbar .pill input { width:auto; min-width:110px; }

    #userId { min-width: 220px; max-width: 260px; }

    .meta{padding:10px}
    .meta .name{font-size:14px;font-weight:700}
    .meta .sub{font-size:12px;color:var(--muted)}
    .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap: 10px 12px; }
    .pill {
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:9999px;
      background:#0b1220;
      white-space:nowrap;
    }
    /* inputs/selects inside pills */
    /* pill controls */
    .pill select,
    .pill input[type="text"] {
      appearance: none;
      background: #0f172a;   /* field bg */
      color: #fff;           /* field text */
      border: 0;
      outline: 0;
      height: 32px;
      line-height: 32px;
      padding: 0 10px;
      min-width: 120px;
      border-radius: 8px;
    }

    /* the OPENED dropdown list */
    .pill select option,
    .pill select optgroup {
      background: #0b1220;   /* list bg */
      color: #fff;           /* list text */
    }

    /* focus ring so it's visible on dark */
    .pill select:focus,
    .pill input[type="text"]:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    /* checkbox pill */
    .pill-checkbox { padding-right:12px; }
    .pill-checkbox input[type="checkbox"] { width:16px; height:16px; }
    /* small screens: allow nice wrapping */
    /* buttons match pill height */
    .btn, .btn-ghost { height:34px; line-height:34px; padding:0 12px; border-radius:10px; }
    @media (max-width: 820px) {
      .pill select, .pill input[type="text"] { min-width: 140px; }
      #userId { min-width: 200px; }
    }
    .footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--line)}
    .page{display:flex;gap:8px;align-items:center}
    .page input{width:72px;text-align:center}
    .balances{display:flex;gap:8px}
    .badge{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:8px 12px}
    .hidden{display:none}
    a{color:var(--accent2)}

    .inv-loader{display:flex;align-items:center;gap:.5rem;margin:.5rem 0;font-size:.95rem}
    .inv-loader.hidden{display:none}
    .inv-loader .spinner{
      width:16px;height:16px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;
      display:inline-block;animation:inv-spin .8s linear infinite
    }
    @keyframes inv-spin{to{transform:rotate(360deg)}}

    /* Image popup (lightbox) */
    #imgPopup {
      position: fixed;
      display: none;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #imgPopup img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    #imgPopup.closeable { cursor: pointer; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hdr">
        <h1>TLK Collection <span class="muted" id="subtitle">(enter a Discord ID and search)</span></h1>
        <div class="title-row">
          <a href="dex.html" target="_blank" 
             style="margin-left:15px; font-size:14px; color:#4da3ff; text-decoration:none;">
            ➜ Open Card Dex
          </a>
        </div>
        <div class="balances">
          <div class="badge">🎟 Tickets: <span id="tickets">–</span></div>
          <div class="badge">🪙 Tokens: <span id="tokens">–</span></div>
        </div>
      </div>
      <div class="row" id="filters">
        <input id="userId" class="input col-span-2" placeholder="Discord ID (preferred) or @username" />
        <label class="pill">Rarity:
          <select id="rarity">
            <option value="ALL">Rarity: ALL</option>
            <option>N</option><option>R</option><option>AR</option><option>SR</option><option>SSR</option>
          </select>
        </label>
        <label class="pill">position:
          <select id="position">
            <option value="ALL">Position: ALL</option>
            <option>GK</option><option>RB</option><option>LB</option><option>CB</option><option>DM</option><option>CM</option><option>AM</option><option>RW</option><option>LW</option><option>ST</option>
          </select>
        </label>
        <label class="pill">batch:
          <select id="batch">
            <option value="ALL">Batch: ALL</option>
            <option value="Base">Base</option>
            <option value="Base U">Base U</option>
          </select>
        </label>
        <label class="pill">Club:
          <select id="club">
            <option value="ALL" selected>ALL</option>
          </select>
        </label>
        <label class="pill">Sort:
          <select id="sortBy">
            <option value="rarity_club" selected>Rarity</option>
            <option value="club">Club</option>
            <option value="position">Position (GK→ST)</option>
            <option value="name">Name (A→Z)</option>
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="count_desc">Most dupes first</option>
            <option value="count_asc">Least dupes first</option>
            </select>
        </label>
        <label class="pill"><input type="checkbox" id="uniqueOnly"/> Unique only</label>
        <div class="toolbar">
          <button class="btn" id="btnSearch">Search</button>
          <button class="btn alt" id="btnReset">Reset</button>
        </div>
        <div id="loader" class="inv-loader hidden" aria-live="polite">
          <span class="spinner"></span> Loading…
        </div>
      </div>


      <div id="dex" class="grid" aria-live="polite"></div>
      <div class="footer">
        <div class="muted" id="countInfo">0 cards</div>
        <div class="page">
          <button class="btn alt" id="prevBtn">Prev</button>
          <input id="page" class="input" value="1" />
          <span class="muted">/ <span id="pages">1</span></span>
          <select id="pageSize" class="input">
            <option>24</option><option selected>48</option><option>96</option>
          </select>
          <button class="btn alt" id="nextBtn">Next</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin:12px 4px">Tip: share a link like <code>?u=123456789012345678&r=SSR&p=ST</code> to pre-fill filters for a user.</p>
  </div>
  <div id="imgPopup" class="closeable">
    <img src="" alt="preview">
  </div> 
<script>
// ======= CONFIG =======
// Force config: no localStorage, no prompts
const API_BASE   = 'https://the-last-kick.keithcheung129.workers.dev/api';
//------- const API_SECRET = ''; // not needed; Worker injects secret


// =======================

const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
const qs = new URLSearchParams(location.search);




// helpers
const byId = (id) => {
  const el = document.getElementById(id);
  if (!el) console.warn(`Missing element #${id}`);
  return el;
};
const val = (id, fallback = "") => (byId(id)?.value ?? fallback);
const chk = (id) => !!byId(id)?.checked;

function setLoading(v){
  const el  = $('loader');     // NOT '#loader'
  const btn = $('searchBtn');  // NOT '#searchBtn'
  if (el){
    if (v) el.classList.remove('hidden');
    else   el.classList.add('hidden');
  }
  if (btn) btn.disabled = !!v;
}



  
// ---- sorting helpers ----
const RARITY_ORDER   = ["GOD","SSR","SR","AR","R","N","U","ALL"]; // put your exact tiers here
const POSITION_ORDER = ["GK","CB","RB","LB","DM","CM","AM","LW","RW","ST","MGR","STM","EVE","ALL"];

const U = (s) => String(s ?? "").toUpperCase();
const rank = (val, order) => {
  const i = order.indexOf(U(val));
  return i === -1 ? 999 : i;
};

let ALL_ITEMS = [];      // full result of the last search


function toMs(v){
  if (v == null || v === "") return 0;
  if (typeof v === "number") return v < 1e12 ? v * 1000 : v; // seconds → ms
  // string: try number first
  const n = Number(v);
  if (!Number.isNaN(n)) return n < 1e12 ? n * 1000 : n;
  // ISO/date-like string
  const d = Date.parse(v);
  return Number.isNaN(d) ? 0 : d;
}
  

function sortItems(items, mode) {
  items.sort((a, b) => {
    const ra = rank(a.rarity,   RARITY_ORDER),   rb = rank(b.rarity,   RARITY_ORDER);
    const pa = rank(a.position, POSITION_ORDER), pb = rank(b.position, POSITION_ORDER);
    const ca = U(a.club), cb = U(b.club);                     // <-- add
    const ba = U(a.batch), bb = U(b.batch);
    const na = (a.name || a.player || a.printcode || a.card_id || "").toString();
    const nb = (b.name || b.player || b.printcode || b.card_id || "").toString();
    const ta = toMs(a.acquired_ts ?? a.acquiredAt ?? a.ts);
    const tb = toMs(b.acquired_ts ?? b.acquiredAt ?? b.ts);
    const qa = freq[keyOf(a)] || 1;
    const qb = freq[keyOf(b)] || 1;

    switch (mode) {
      case "rarity_asc":   return rb - ra || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);
      case "club":         return ca.localeCompare(cb) || pa - pb || ra - rb || na.localeCompare(nb);
      case "position":     return pa - pb || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "batch":        return ba.localeCompare(bb) || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "name":         return na.localeCompare(nb);
      case "newest":       return (tb - ta) || na.localeCompare(nb);
      case "oldest":       return (ta - tb) || na.localeCompare(nb);
      case "count_desc":   return (qb - qa) || na.localeCompare(nb);
      case "count_asc":    return (qa - qb) || na.localeCompare(nb);
      case "rarity_desc":
      default:             return ra - rb || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);  // <-- default
    }
  });
  return items;
}


function applySortAndShow() {
  const sortMode = $('#sortBy').value || 'rarity_club';
  const page = Math.max(1, parseInt($('#page').value || '1') || 1);
  const pageSize = Math.max(1, parseInt($('#pageSize').value || '48') || 48);

  // sort a copy so we don’t mutate ALL_ITEMS
  const arr = sortItems([...ALL_ITEMS], sortMode);

  // slice for the current page
  const start = (page - 1) * pageSize;
  const view  = arr.slice(start, start + pageSize);

  // render the current page
  render(view);

  // update counts / pager UI
  updateCounts(arr.length, page, pageSize);
  // also update “shown/total” text like you do today
  $('#countInfo').textContent = `${view.length} shown • ${arr.length} total`;

  // friendly empty state
  if (!view.length) {
    $('#dex').innerHTML = '<div style="padding:12px;opacity:.7">No cards match your filters for this user.</div>';
  }
}


function buildQuery() {
  return {
    user_id: val("userId").trim(),
    page: Math.max(1, parseInt(val("page", "1")) || 1),
    page_size: Math.max(1, parseInt(val("pageSize", "48")) || 48),
    unique_only: chk("uniqueOnly"),
    rarity: val("rarity", "ALL") || "ALL",
    position: val("position", "ALL") || "ALL",
    batch: val("batch", "ALL") || "ALL",
    club:     val("club", "ALL")     || "ALL",
  };
}



function applyQS(){
  if(qs.get('u')) $('#userId').value = qs.get('u');
  if(qs.get('r')) $('#rarity').value = qs.get('r');
  if(qs.get('p')) $('#position').value = qs.get('p');
  if(qs.get('b')) $('#batch').value = qs.get('b');
  if(qs.get('page')) $('#page').value = qs.get('page');
  if(qs.get('c')) $('#club').value = qs.get('c');
}





async function callCollection(params){
  // Simple request: no custom headers, and text/plain (NOT application/json)
  const res = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }, // JSON is fine; Worker handles CORS
    body: JSON.stringify({ action: 'collection', ...params })
  });


  const text = await res.text();
  if (!res.ok) throw new Error(`API ${res.status}: ${text.slice(0,500)}`);
  
  let body;
  try { body = JSON.parse(text); } catch { throw new Error('Bad JSON from API'); }

  // Worker returns { ok, data, status }. Fall back to raw for legacy.
  return (body && typeof body === 'object' && 'ok' in body && 'data' in body) ? body.data : body;

  
}



function render(items){
  const root = $('#dex');
  root.innerHTML = '';
  for(const it of items){
    const div = document.createElement('div');
    div.className='card';
    const img = document.createElement('img');
    img.className='thumb';
    img.loading='lazy';
    img.src = it.image_url || it.image_ref || '';
    img.alt = it.name || it.printcode || it.card_id || '';
    div.appendChild(img);
    const meta = document.createElement('div');
    meta.className='meta';
    const nm = document.createElement('div');
    nm.className='name'; nm.textContent = it.name || it.player || it.printcode || it.card_id || '—';
    const sb = document.createElement('div');
    sb.className='sub';
    const bits = [it.rarity, it.club, it.position, it.batch, it.serial?('#'+it.serial):null].filter(Boolean);
    sb.textContent = bits.join(' • ');
    meta.appendChild(nm); meta.appendChild(sb);
    // NEW: show card_id under the card
    if (it.card_id) {
      const idRow = document.createElement('div');
      idRow.className = 'sub';
      idRow.textContent = 'ID: ' + it.card_id;
      meta.appendChild(idRow);
    }

    enableImagePopup(img);
    div.appendChild(meta);
    root.appendChild(div);
  }
}

// --- Image popup ---
const popup = document.getElementById("imgPopup");
const popupImg = popup.querySelector("img");

// open when any thumbnail is clicked
function enableImagePopup(img) {
  img.addEventListener("click", () => {
    popupImg.src = img.src;
    popup.style.display = "flex";
  });
}

// close popup on click
popup.addEventListener("click", () => {
  popup.style.display = "none";
  popupImg.src = "";
});


  
function updateBalances(bal){
  $('#tickets').textContent = bal?.tickets ?? '0';
  $('#tokens').textContent = bal?.tokens ?? '0';
}

function updateCounts(total, page, pageSize){
  const pages = Math.max(1, Math.ceil(total / pageSize));
  $('#countInfo').textContent = `${total} card${total===1?'':'s'}`;
  $('#pages').textContent = pages;
  $('#page').value = Math.min(page, pages);
  $('#prevBtn').disabled = (page<=1);
  $('#nextBtn').disabled = (page>=pages);
}

async function search() {
  setLoading(true);
  try {
    // 1) Build query from inputs (keep your current helper)
    const q = buildQuery();

    // 2) Fetch ALL pages
    const combined = [];
    let page = 1;
    const fetchSize = 200; // batch size per request (tune as needed)
    let total = 0;

    while (true) {
      const res = await callCollection({ ...q, page, page_size: fetchSize });
      const items = (res.items || []).map(it => ({
        ...it,
        printcode: it.printcode ?? it.card_id
      }));
      combined.push(...items);

      total = Number(res.total ?? combined.length);
      if (combined.length >= total) break;
      page++;
      // safety: stop runaway loops
      if (page > 200) break;
    }

    // 3) Update club filter options based on the full set (same code you had)
    (function populateClubs(items) {
      const sel = byId('club');
      if (!sel) return;
      const cur = sel.value || 'ALL';
      const clubs = Array.from(new Set(items.map(it => (it.club || '').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = '<option value="ALL">ALL</option>' + clubs.map(c=>`<option>${c}</option>`).join('');
      if (Array.from(sel.options).some(o => o.value === cur)) sel.value = cur;
    })(combined);

    // 4) Balances (unchanged)
    const balances = (combined.length && typeof res !== 'undefined' && res.balances) ? res.balances
                     : { tickets: 0, tokens: 0 };
    updateBalances(balances);

    // 5) Save to memory and show the current page
    ALL_ITEMS = combined;
    applySortAndShow();

  } catch (err) {
    console.error(err);
    alert('Failed to load collection. Check API base/secret in code.');
  } finally {
    setLoading(false);          // <-- add this block
}



// ---- Wire up safely after DOM is ready ----
document.addEventListener('DOMContentLoaded', () => {
  const safeOn = (id, evt, fn) => {
    const el = document.getElementById(id);
    if (!el) { console.warn(`Missing #${id}`); return; }
    el.addEventListener(evt, fn);
  };

  safeOn('btnSearch', 'click', () => { byId('page').value = 1; search(); });
  safeOn('btnReset',  'click', () => { location.href = location.pathname; });
  safeOn('prevBtn',   'click', () => {
    const cur = +(val('page','1')); byId('page').value = Math.max(1, cur - 1);
    applySortAndShow();
  });
  safeOn('club',      'change', () => { byId('page').value = 1; search(); }); // club changes the dataset → refetch
  safeOn('sortBy',    'change', () => { byId('page').value = 1; applySortAndShow(); });
  safeOn('nextBtn',   'click', () => {
    const cur = +(val('page','1')); byId('page').value = cur + 1;
    applySortAndShow();
  });
  safeOn('pageSize',  'change', () => { byId('page').value = 1; applySortAndShow(); });


  // auto-search if ?u= is present
  const u = new URLSearchParams(location.search).get('u');
  if (u) { byId('userId').value = u; search(); }
});



// Keep the config shortcut
window.addEventListener('keydown', (ev) => {
  if (ev.key === 'c' && (ev.ctrlKey || ev.metaKey)) {
    const base = prompt('API base URL', API_BASE);
    if (base) localStorage.setItem('tlk_api_base', base);
    location.reload();

  }
});
</script>

</body>
</html>
