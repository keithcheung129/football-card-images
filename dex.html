<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Last Kick — Dex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e0f12;
      --panel:#151821;
      --panel-2:#1c2030;
      --text:#e8ecf6;
      --muted:#9aa3b2;
      --accent:#6ea8fe;
      --accent-2:#7ee787;
      --danger:#ff7b72;
      --ring:#2d3a5c;
      --chip:#242a3b;
      --card-dim:0.35; /* darkness for unowned cards */
      --grid-gap:14px;
      --radius:14px;
      --shadow:0 6px 20px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b0c10 0%, #0e0f12 80%);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      max-width:1200px;margin:28px auto;padding:0 16px;display:grid;grid-template-columns: 260px 1fr;gap:20px;
    }
    header{
      grid-column:1/-1;display:flex;align-items:center;gap:16px;margin-bottom:2px;
    }
    .title{
      font-weight:700;font-size:22px;letter-spacing:.3px;
    }
    .spacer{flex:1}
    .ghost-link{
      padding:10px 14px;border:1px solid var(--ring);border-radius:10px;background:transparent;color:var(--text);
    }
    .panel{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid #23283a;border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .filters{
      padding:14px;position:sticky;top:14px;
    }
    .filters h3{margin:0 0 12px 0;font-weight:700;font-size:15px}
    .row{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px}
    label{display:flex;flex-direction:column;gap:6px}
    .lbl{font-size:12px;color:var(--muted)}
    input[type="text"], select{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid #2b334b;background:#0e111b;color:var(--text);
      outline:none;
    }
    .inline{display:flex;gap:8px}
    .btn{
      appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;
    }
    .btn-primary{background:var(--accent);color:#0a0a0a}
    .btn-ghost{background:#20263a;color:var(--text);border:1px solid #2f3a5d}
    .legend{
      margin-top:14px;padding:12px;border-radius:10px;background:#111525;border:1px solid #28304a;color:var(--muted)
    }
    .legend h4{margin:0 0 8px 0;color:var(--text);font-size:13px}
    .legend table{width:100%;border-collapse:collapse;font-size:12px}
    .legend th,.legend td{padding:6px;border-bottom:1px solid #242b42;text-align:left}
    .legend th{color:var(--muted);font-weight:600}
    .legend .ok{color:var(--accent-2)}
    .results-head{
      display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #242a3b;
    }
    .results-count{color:var(--muted)}
    .grid{
      padding:14px;
      display:grid;grid-template-columns:repeat( auto-fill, minmax(180px,1fr) );gap:var(--grid-gap);
    }
    .card{
      position:relative;border-radius:12px;overflow:hidden;background:#0b0d14;border:1px solid #22283a;box-shadow:var(--shadow);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .imgbox{
      position:relative;aspect-ratio: 3/4;background:#0e111a;display:flex;align-items:center;justify-content:center;
    }
    .imgbox img{
      width:100%;height:100%;object-fit:cover;display:block;filter:brightness(var(--card-dim));
      transition:filter .2s ease;
      background:#0c0f16;
    }
    .card.owned img{filter:none}
    .badge{
      position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);border:1px solid #2c3350;padding:4px 8px;border-radius:999px;font-size:12px
    }
    .owned .badge{background:rgba(9,14,30,.75);border-color:#345;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
    .qty{
      position:absolute;bottom:8px;right:8px;background:#0d1b10;color:#bff0bf;border:1px solid #274c2a;padding:4px 8px;border-radius:999px;font-size:12px;display:none;
    }
    .owned .qty{display:inline-block}
    .meta{
      padding:10px 10px 12px 10px;display:grid;gap:6px;background:linear-gradient(180deg,rgba(20,24,36,.6),rgba(12,14,22,.8));
      border-top:1px solid #20263a
    }
    .name{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    .card-id{
      font-size:12px;color:#a9b4c8;background:#0c1220;border:1px solid #1f2842;border-radius:8px;padding:3px 6px;display:inline-flex;gap:6px;align-items:center;
      width:max-content;max-width:100%;
    }
    .copy{
      cursor:pointer;border:0;background:transparent;color:var(--accent);font-weight:700
    }
    /* Loader */
    .applybar{padding:12px 14px;display:flex;align-items:center;gap:8px;border-top:1px solid #242a3b}
    .spinner{width:16px;height:16px;border:2px solid #2f3a5a;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;display:none}
    .spinner.show{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Modal */
    .modal{
      position:fixed;inset:0;background:rgba(3,5,12,.8);display:none;align-items:center;justify-content:center;padding:20px;z-index:20;
    }
    .modal.open{display:flex}
    .modal-inner{
      width:min(92vw,900px);background:#0b0d14;border:1px solid #2a314a;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.6);
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #242a3b}
    .modal-body{padding:0;background:#0a0c12}
    .modal-body img{display:block;max-width:100%;height:auto;width:100%}
    .xbtn{background:transparent;border:1px solid #38425f;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    /* Chips */
    .chiprow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #2b3450;border-radius:999px;padding:4px 8px;font-size:12px}
    /* Mobile tweak */
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
      .filters{position:static}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Dex — All Cards</div>
      <div class="spacer"></div>
      <a class="ghost-link" href="./inventory.html">↩ Inventory</a>
    </header>

    <!-- Left: Filters -->
    <aside class="panel filters">
      <h3>Filters & Options</h3>
      <div class="row">
        <label>
          <span class="lbl">Discord ID (optional)</span>
          <input id="discordId" type="text" placeholder="e.g. 123456789012345678" />
        </label>
      </div>
      <div class="row">
        <label>
          <span class="lbl">Type</span>
          <select id="fType">
            <option value="">All</option>
            <option>Player</option>
            <option>Manager</option>
            <option>Stadium</option>
            <option>Event</option>
          </select>
        </label>
        <label>
          <span class="lbl">Rarity</span>
          <select id="fRarity">
            <option value="">All</option>
            <option>N</option>
            <option>R</option>
            <option>AR</option>
            <option>SR</option>
            <option>SSR</option>
          </select>
        </label>
        <label>
          <span class="lbl">Position</span>
          <select id="fPos">
            <option value="">All</option>
            <option>GK</option>
            <option>DEF</option>
            <option>MID</option>
            <option>FWD</option>
            <option>OT</option>
          </select>
        </label>
        <label>
          <span class="lbl">Batch</span>
          <select id="fBatch">
            <option value="">All</option>
            <option>Base</option>
            <option>Base SSR</option>
            <option>Base U</option>
            <!-- add more as you release -->
          </select>
        </label>
        <label>
          <span class="lbl">Club</span>
          <input id="fClub" type="text" placeholder="Search club…" />
        </label>
      </div>

      <div class="row">
        <label>
          <span class="lbl">Sort by</span>
          <select id="sortBy">
            <option value="dex">Default (Dex)</option>
            <option value="nameAZ">Name A → Z</option>
            <option value="nameZA">Name Z → A</option>
            <option value="rarHi">Rarity (SSR→N)</option>
            <option value="rarLo">Rarity (N→SSR)</option>
            <option value="clubAZ">Club A → Z</option>
            <option value="batchAZ">Batch A → Z</option>
          </select>
        </label>
      </div>

      <div class="applybar">
        <button id="applyBtn" class="btn btn-primary">Apply</button>
        <div id="applySpin" class="spinner" aria-hidden="true"></div>
        <button id="resetBtn" class="btn btn-ghost">Reset</button>
      </div>

      <div id="legend" class="legend" hidden>
        <h4>Sell & Craft (by rarity)</h4>
        <table>
          <thead><tr><th>Rarity</th><th>Sell</th><th>Craft</th></tr></thead>
          <tbody id="legendRows"></tbody>
        </table>
      </div>
    </aside>

    <!-- Right: Results -->
    <section class="panel">
      <div class="results-head">
        <div class="results-count" id="countTxt">Loading cards…</div>
        <div class="spacer"></div>
        <div class="chiprow" id="activeChips"></div>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-inner">
      <div class="modal-head">
        <div id="modalTitle" class="name">Card</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div class="modal-body">
        <img id="modalImg" alt="Card full view" />
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG – tweak to match your Worker
    // ==========================
    const API = {
      cards:   '/api/cards', // returns array of card objects
      holding: (discordId) => `/api/collection?discord_id=${encodeURIComponent(discordId)}&active_only=1`,
    };

    // Expected card fields (per /api/cards):
    // {
    //   card_id: "P0123", name: "Erling Haaland",
    //   image_url: "https://...", // full-size card image
    //   type: "Player" | "Manager" | "Stadium" | "Event",
    //   rarity: "N"|"R"|"AR"|"SR"|"SSR",
    //   position: "GK"|"DEF"|"MID"|"FWD"|"OT" (for players) or "" (others),
    //   batch: "Base" | "Base SSR" | "Base U" | ...,
    //   club: "Man City" | ...
    //   dex_order: number // for default sort
    // }

    // Rarity rank for sorting
    const RANK = { SSR:5, SR:4, AR:3, R:2, N:1 };

    // State
    let ALL = [];               // all cards
    let FILTERED = [];          // filtered cards
    let HOLDINGS = {};          // { card_id: qty }
    let PRICES = null;          // { byRarity: { R:{sell,craft}, ... } }
    let META = null;   // will hold { CraftingCosts: {...}, SELL_YIELD: {...} } if present


    // Elements
    const el = (id) => document.getElementById(id);
    const grid = el('grid');
    const countTxt = el('countTxt');
    const applyBtn = el('applyBtn');
    const applySpin = el('applySpin');
    const resetBtn = el('resetBtn');
    const legend = el('legend');
    const legendRows = el('legendRows');
    const activeChips = el('activeChips');

    // Filters
    const fType  = el('fType');
    const fRar   = el('fRarity');
    const fPos   = el('fPos');
    const fBatch = el('fBatch');
    const fClub  = el('fClub');
    const sortBy = el('sortBy');
    const discordId = el('discordId');

    // Modal
    const modal = el('modal');
    const modalImg = el('modalImg');
    const modalTitle = el('modalTitle');
    const modalClose = el('modalClose');

    // --------------------------
    // Init
    // --------------------------
    boot();

    async function boot(){
      try {
        // hydrate from URL params
        readParams();

        // parallel fetch core data
        const [cardsRes] = await Promise.allSettled([
          fetch(API.cards, { credentials:'include' })
        ]);

        if (cardsRes.status === 'fulfilled') {
          const raw = await cardsRes.value.json();
          if (Array.isArray(raw)) {
            ALL = raw;
            META = null;
          } else {
            ALL  = raw.cards || [];
            META = raw.meta  || null;   // look for CraftingCosts / SELL_YIELD here
          }
        } else {
          throw new Error('Failed to load cards list.');
        }

        renderLegendFromMeta(META);


        if (pricesRes.status === 'fulfilled' && pricesRes.value.ok) {
          PRICES = await pricesRes.value.json();
          renderLegend(PRICES);
        } // else silently hide legend

        // initial render: show all cards DIMMED (owned overlay will update after holdings load)
        FILTERED = ALL.slice();
        defaultSort(FILTERED);
        render();

        

        countTxt.textContent = `${FILTERED.length} cards`;
      } catch (err) {
        countTxt.textContent = 'Failed to load. Check API / origin.';
        console.error(err);
      }

      // bind events
      applyBtn.addEventListener('click', onApply);
      resetBtn.addEventListener('click', onReset);

      // modal events
      modal.addEventListener('click', (e)=> {
        if (e.target === modal) closeModal();
      });
      modalClose.addEventListener('click', closeModal);
    }


    function renderLegendFromMeta(meta){
      legend.hidden = true;
      legendRows.innerHTML = '';
      if (!meta) return;

      const craft = meta.CraftingCosts || meta.craftingCosts || null;
      const sell  = meta.SELL_YIELD    || meta.sell_yield    || null;

      // Need at least one of them to show the table
      if (!craft && !sell) return;

      const order = ['SSR','SR','AR','R','N'];
      for (const r of order){
        const tr = document.createElement('tr');
        const craftVal = craft?.[r] ?? '—';
        const sellVal  = sell?.[r]  ?? '—';
        tr.innerHTML = `<td><strong>${r}</strong></td><td>${sellVal}</td><td>${craftVal}</td>`;
        legendRows.appendChild(tr);
      }
      legend.hidden = false;
    }


    async function loadHoldings(id){
      HOLDINGS = {};
      if (!id) return;
      try{
        const res = await fetch(API.holding(id), { credentials:'include' });
        if (!res.ok) throw new Error('Holdings fetch failed');
        const data = await res.json();
        HOLDINGS = data?.holdings || {};
        addChip(`Owned view for ${shortId(id)}`);
      }catch(e){
        console.warn('Could not load holdings for', id, e);
        addChip('Owned view unavailable');
      }
    }

    // --------------------------
    // Apply / Reset
    // --------------------------
    async function onApply(){
      // loader visible immediately; Apply must work even with NO ID
      setApplying(true);
      try {
        // 1) Update holdings (if any ID given). Never block filtering on missing ID.
        const id = discordId.value.trim();
        if (id) {
          await loadHoldings(id);
        } else {
          HOLDINGS = {}; // clear if removed
          addChip('Showing all cards (no ID)');
        }

        // 2) Filter/sort
        applyFilters();
        applySort();

        // 3) Persist to URL for shareability
        writeParams();

        // 4) Render
        render();

        countTxt.textContent = `${FILTERED.length} cards`;
      } finally {
        setApplying(false);
      }
    }

    function onReset(){
      // clear inputs
      [fType,fRar,fPos,fBatch,sortBy].forEach(x=>x.value='');
      fClub.value = '';
      discordId.value = '';
      HOLDINGS = {};
      activeChips.innerHTML = '';
      // reset list
      FILTERED = ALL.slice();
      defaultSort(FILTERED);
      writeParams(); // clear URL state
      render();
      countTxt.textContent = `${FILTERED.length} cards`;
    }

    function setApplying(on){
      applyBtn.disabled = on;
      resetBtn.disabled = on;
      applySpin.classList.toggle('show', on);
    }

    // --------------------------
    // Filtering
    // --------------------------
    function applyFilters(){
      const t = fType.value.trim();
      const r = fRar.value.trim();
      const p = fPos.value.trim();
      const b = fBatch.value.trim();
      const c = fClub.value.trim().toLowerCase();

      activeChips.innerHTML = '';
      if (t) addChip(`Type: ${t}`);
      if (r) addChip(`Rarity: ${r}`);
      if (p) addChip(`Pos: ${p}`);
      if (b) addChip(`Batch: ${b}`);
      if (c) addChip(`Club: ${c}`);

      FILTERED = ALL.filter(card=>{
        if (t && (card.type||'') !== t) return false;
        if (r && (card.rarity||'') !== r) return false;
        if (p && (card.position||'') !== p) return false;
        if (b && (card.batch||'') !== b) return false;
        if (c && !String(card.club||'').toLowerCase().includes(c)) return false;
        return true;
      });
    }

    function addChip(txt){
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = txt;
      activeChips.appendChild(span);
    }

    // --------------------------
    // Sorting
    // --------------------------
    function defaultSort(arr){
      // by dex_order asc, then rarity hi→lo, then name
      arr.sort((a,b)=>{
        const dx = (a.dex_order??999999) - (b.dex_order??999999);
        if (dx) return dx;
        const rr = (RANK[b.rarity]||0) - (RANK[a.rarity]||0);
        if (rr) return rr;
        return strCmp(a.name,b.name);
      });
    }
    function applySort(){
      const mode = sortBy.value;
      const s = (a,b)=>0;
      switch(mode){
        case 'nameAZ':
          FILTERED.sort((a,b)=>strCmp(a.name,b.name));break;
        case 'nameZA':
          FILTERED.sort((a,b)=>strCmp(b.name,a.name));break;
        case 'rarHi':
          FILTERED.sort((a,b)=>(RANK[b.rarity]||0)-(RANK[a.rarity]||0) || strCmp(a.name,b.name));break;
        case 'rarLo':
          FILTERED.sort((a,b)=>(RANK[a.rarity]||0)-(RANK[b.rarity]||0) || strCmp(a.name,b.name));break;
        case 'clubAZ':
          FILTERED.sort((a,b)=>strCmp(a.club,b.club) || strCmp(a.name,b.name));break;
        case 'batchAZ':
          FILTERED.sort((a,b)=>strCmp(a.batch,b.batch) || strCmp(a.name,b.name));break;
        default:
          defaultSort(FILTERED);
      }
    }
    function strCmp(a,b){
      return String(a||'').localeCompare(String(b||''), undefined, { sensitivity:'base' });
    }

    // --------------------------
    // Render
    // --------------------------
    function render(){
      grid.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const card of FILTERED){
        const ownedQty = HOLDINGS[card.card_id] || 0;

        const item = document.createElement('div');
        item.className = 'card' + (ownedQty>0? ' owned' : '');
        item.dataset.cardId = card.card_id;

        const imgbox = document.createElement('div');
        imgbox.className = 'imgbox';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = card.name || card.card_id;
        img.src = card.image_url;
        img.addEventListener('click', ()=> openModal(card));
        imgbox.appendChild(img);

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = `${card.rarity || '—'}`;
        imgbox.appendChild(badge);

        const qty = document.createElement('div');
        qty.className = 'qty';
        qty.textContent = `× ${ownedQty}`;
        imgbox.appendChild(qty);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = card.name || '—';

        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.innerHTML = [
          card.type ? `<span>${card.type}</span>` : '',
          card.position ? `<span>${card.position}</span>` : '',
          card.batch ? `<span>${card.batch}</span>` : '',
          card.club ? `<span>${card.club}</span>` : '',
        ].filter(Boolean).join('');

        const idrow = document.createElement('div');
        idrow.className = 'card-id';
        idrow.innerHTML = `<span>${card.card_id}</span><button class="copy" title="Copy ID">Copy</button>`;
        idrow.querySelector('.copy').addEventListener('click', ()=>{
          navigator.clipboard.writeText(card.card_id).then(()=>{
            toast(`Copied ${card.card_id}`);
          });
        });

        meta.appendChild(name);
        meta.appendChild(sub);
        meta.appendChild(idrow);

        item.appendChild(imgbox);
        item.appendChild(meta);
        frag.appendChild(item);
      }
      grid.appendChild(frag);
    }

    // --------------------------
    // Modal
    // --------------------------
    function openModal(card){
      modal.classList.add('open');
      modalImg.src = card.image_url;
      modalTitle.textContent = `${card.name} — ${card.card_id}`;
    }
    function closeModal(){
      modal.classList.remove('open');
      modalImg.src = '';
    }

    // --------------------------
    // URL State
    // --------------------------
    function readParams(){
      const p = new URLSearchParams(location.search);
      discordId.value = p.get('id') || '';
      fType.value = p.get('t') || '';
      fRar.value  = p.get('r') || '';
      fPos.value  = p.get('p') || '';
      fBatch.value= p.get('b') || '';
      fClub.value = p.get('c') || '';
      sortBy.value= p.get('s') || '';
    }
    function writeParams(){
      const p = new URLSearchParams();
      if (discordId.value.trim()) p.set('id',discordId.value.trim());
      if (fType.value) p.set('t',fType.value);
      if (fRar.value) p.set('r',fRar.value);
      if (fPos.value) p.set('p',fPos.value);
      if (fBatch.value) p.set('b',fBatch.value);
      if (fClub.value.trim()) p.set('c',fClub.value.trim());
      if (sortBy.value) p.set('s',sortBy.value);
      const q = p.toString();
      const url = q ? `?${q}` : location.pathname;
      history.replaceState(null,'',url);
    }
    function shortId(s){ return s.length>6 ? s.slice(0,3)+'…'+s.slice(-3) : s }

    // --------------------------
    // Tiny toast
    // --------------------------
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position='fixed';t.style.bottom='18px';t.style.left='50%';t.style.transform='translateX(-50%)';
      t.style.background='#101526';t.style.border='1px solid #2a3352';t.style.padding='8px 12px';t.style.borderRadius='10px';
      t.style.boxShadow='0 8px 24px rgba(0,0,0,.45)';t.style.zIndex='30';
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1400);
    }
  </script>
</body>
</html>
