<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Last Kick â€” Card Dex</title>
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --card-w: 220px; --card-h: 308px; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); background: rgba(17,17,17,0.65); }
    .chip { border: 1px solid rgba(255,255,255,0.12); }
    .grid-auto { grid-template-columns: repeat(auto-fill, minmax(var(--card-w), 1fr)); }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .card-img { width: 100%; height: var(--card-h); object-fit: cover; border-radius: 1rem; }
    .fade-in { animation: fade .35s ease-in both; }
    @keyframes fade { from { opacity: 0; transform: translateY(4px) } to { opacity: 1; transform: none } }
    .badge { font-variant-numeric: tabular-nums; }
    .copy-toast { position: fixed; inset-inline: 0; bottom: 16px; margin: auto; max-width: 320px; }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <header class="sticky top-0 z-40 glass border-b border-neutral-800">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-emerald-400/20 to-cyan-400/20 grid place-items-center ring-1 ring-emerald-300/30">
        <span class="font-extrabold text-emerald-300">TLK</span>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-lg sm:text-xl font-bold tracking-tight truncate">The Last Kick â€” Card Dex</h1>
        <p class="text-xs text-neutral-400 truncate">Browse every card across batches, clubs, rarities & more.</p>
      </div>
      <!-- Right: links & soft stats -->
      <nav class="hidden sm:flex items-center gap-3">
        <a href="./inventory.html" class="text-sm text-emerald-300 hover:text-emerald-200 underline underline-offset-4">Open Inventory â†’</a>
      </nav>
      <div id="stats" class="text-xs text-neutral-400 hidden sm:block"></div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    <!-- Controls -->
    <section class="mb-4 grid grid-cols-1 md:grid-cols-12 gap-3">
      <div class="md:col-span-4">
        <label class="sr-only" for="q">Search</label>
        <input id="q" type="search" placeholder="Search name, club, effectâ€¦"
               class="w-full rounded-xl bg-neutral-900 border border-neutral-800 px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-400 shadow-soft" />
      </div>
      <div class="md:col-span-2">
        <select id="club" class="w-full rounded-xl bg-neutral-900 border border-neutral-800 px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-400">
          <option value="">All Clubs</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <select id="rarity" class="w-full rounded-xl bg-neutral-900 border border-neutral-800 px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-400">
          <option value="">All Rarities</option>
          <option value="N">N</option>
          <option value="R">R</option>
          <option value="AR">AR</option>
          <option value="SR">SR</option>
          <option value="SSR">SSR</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <select id="type" class="w-full rounded-xl bg-neutral-900 border border-neutral-800 px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-400">
          <option value="">All Types</option>
          <option value="Speed">Speed</option>
          <option value="Technical">Technical</option>
          <option value="Physical">Physical</option>
          <option value="GK">GK</option>
          <option value="OT">Outfield</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <select id="batch" class="w-full rounded-xl bg-neutral-900 border border-neutral-800 px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-400">
          <option value="">All Batches</option>
          <option value="Base">Base</option>
          <option value="Base SSR">Base SSR</option>
          <option value="Base U">Base U</option>
        </select>
      </div>
      <div class="md:col-span-12 flex items-center gap-3">
        <div class="flex items-center gap-2">
          <label for="sort" class="text-xs text-neutral-400">Sort</label>
          <select id="sort" class="rounded-xl bg-neutral-900 border border-neutral-800 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-400">
            <option value="rarity-desc">Rarity (SSRâ†’N)</option>
            <option value="name-asc">Name (Aâ†’Z)</option>
            <option value="club-asc">Club (Aâ†’Z)</option>
            <option value="batch-asc">Batch (Aâ†’Z)</option>
            <option value="id-asc">ID (Aâ†’Z)</option>
          </select>
        </div>
        <button id="resetBtn" class="rounded-xl bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 px-3 py-2 text-sm">Reset</button>
        <a href="./inventory.html" class="ml-auto text-sm text-emerald-300 hover:text-emerald-200 underline underline-offset-4">Open Inventory â†’</a>
      </div>
    </section>

    <!-- Grid -->
    <section id="grid" class="grid grid-auto gap-4"></section>

    <!-- Economy Legend -->
    <section class="mt-8">
      <div class="rounded-2xl border border-neutral-800 bg-neutral-900/60 p-4">
        <h2 class="font-semibold mb-3">Crafting & Selling â€” Legend</h2>
        <div id="legend" class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm"></div>
        <p class="text-xs text-neutral-400 mt-2">Values pulled from page config. Adjust in <code>CONFIG.CRAFT</code> and <code>CONFIG.SELL</code>.</p>
      </div>
    </section>

    <!-- Sentinel for lazy rendering -->
    <div id="sentinel" class="h-16"></div>
  </main>

  <!-- Modal -->
  <dialog id="modal" class="backdrop:bg-black/70 rounded-2xl p-0 w-full max-w-3xl">
    <div class="bg-neutral-950 rounded-2xl border border-neutral-800 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-neutral-800">
        <h3 id="modalTitle" class="font-semibold"></h3>
        <button id="closeModal" class="text-sm text-neutral-400 hover:text-neutral-200">Close</button>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <img id="modalImg" class="w-full h-auto rounded-xl shadow-soft" alt="card image" />
        <div class="space-y-3 text-sm">
          <div class="flex gap-2 flex-wrap" id="modalChips"></div>
          <pre id="modalJson" class="bg-neutral-900/60 rounded-xl p-3 overflow-auto border border-neutral-800 text-xs"></pre>
        </div>
      </div>
    </div>
  </dialog>

  <template id="cardTpl">
    <article class="bg-neutral-900 border border-neutral-800 rounded-2xl p-2 shadow-soft fade-in">
      <div class="relative">
        <img class="card-img bg-neutral-800/60" alt="card" />
        <div class="absolute left-2 top-2 flex gap-1 flex-wrap"></div>
        <button class="absolute inset-0" aria-label="Open"></button>
      </div>
      <div class="pt-2 px-1">
        <div class="flex items-center justify-between gap-2">
          <h3 class="truncate font-semibold"></h3>
          <span class="badge text-xs text-neutral-300"></span>
        </div>
        <p class="text-xs text-neutral-400 truncate"></p>
      </div>
      <!-- Card footer: copyable ID -->
      <div class="mt-2">
        <button class="copy-id w-full text-[11px] text-neutral-300/90 bg-neutral-800/60 hover:bg-neutral-800 border border-neutral-700 rounded-xl px-2 py-1">Copy ID</button>
      </div>
    </article>
  </template>

  <div id="toast" class="copy-toast hidden">
    <div class="rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm shadow-soft border border-emerald-300/40">Copied!</div>
  </div>

  <script>
  // ==== CONFIG ==============================================================
  // This page is designed to work with your Cloudflare Worker proxying Google Apps Script.
  // It will try a few conventional endpoints so you don't need to edit code if you kept naming similar to inventory.html.
  const CONFIG = {
    API_BASE: 'https://the-last-kick.keithcheung129.workers.dev/api', // same origin by default. e.g. '' or 'https://yourdomain.tld'
    
    // Field mapping: adapt to your GAS/Worker payload without changing the rest of code
    FIELDS: {
      id: ['id','card_id','printcode','code'],
      name: ['name','player','title'],
      rarity: ['rarity'],
      batch: ['batch','set'],
      club: ['club','team'],
      position: ['pos','position'],
      type: ['type'], // accepts GK/OT or Speed/Technical/Physical
      image: ['image','image_url','image_ref','url'], // full-size image URL
      thumb: ['thumb','thumb_url','thumbnail'] // optional small image URL
    },
    PAGE_SIZE: 48,
    // Economy config (edit to your real values)
    CRAFT: { N: 6, R: 10, AR: 20, SR: 60, SSR: 200 },
    SELL:  { N: 1,  R: 1,  AR: 3, SR: 8,  SSR: 30 }
  };

  // ==== UTILITIES ===========================================================
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  function pick(o, keys, fallback='') {
    for (const k of keys) { if (o && o[k] != null && String(o[k]).length) return o[k]; }
    return fallback;
  }

  function rarityEmoji(r) {
    return { N:'âšª', R:'ðŸŸ¦', AR:'ðŸŸª', SR:'ðŸŸ§', SSR:'ðŸŸ¨' }[r] || 'â¬œ';
  }

  function toStr(x){ return (x==null?'' : String(x)); }

  function normType(t){
    t = toStr(t).toUpperCase();
    if (t === 'GK') return 'GK';
    if (t === 'OT' || t === 'OUTFIELD') return 'OT';
    // Accept speed/technical/physical variants
    if (["SPEED","TECHNICAL","PHYSICAL"].includes(t)) return t[0] + t.slice(1).toLowerCase();
    return t;
  }

  function makeChip(txt){
    const s = document.createElement('span');
    s.className = 'chip text-[11px] px-2 py-0.5 rounded-lg text-neutral-200/90';
    s.textContent = txt;
    return s;
  }

  function buildQueryIndex(items){
    for (const it of items){
      const hay = [it.name, it.club, it.batch, it.position, it.type, it.id].filter(Boolean).join(' ').toLowerCase();
      it.__hay = hay;
    }
  }

  function uniqSorted(values){
    return Array.from(new Set(values.filter(Boolean))).sort((a,b)=>toStr(a).localeCompare(toStr(b)));
  }

  function showToast(){
    const t = qs('#toast');
    if (!t) return; t.classList.remove('hidden');
    setTimeout(()=>t.classList.add('hidden'), 900);
  }

  // ==== DATA LAYER ==========================================================
  async function fetchDex() {
    const base = CONFIG.API_BASE.replace(/\/$/, '');
    for (const ep of CONFIG.ENDPOINTS) {
      try {
        const res = await fetch(base + ep, { credentials: 'include' });
        if (!res.ok) continue;
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : (Array.isArray(data.cards) ? data.cards : null));
        if (!arr) continue;
        const normalized = arr.map(raw => normalizeItem(raw));
        return normalized;
      } catch (e) { /* try next endpoint */ }
    }
    throw new Error('No dex endpoint responded with data. Ensure your Worker exposes /api/dex or /api/cards.');
  }

  function normalizeItem(raw){
    const F = CONFIG.FIELDS;
    const id = pick(raw, F.id);
    const name = pick(raw, F.name);
    const rarity = pick(raw, F.rarity).toUpperCase();
    const batch = pick(raw, F.batch);
    const club = pick(raw, F.club);
    const position = pick(raw, F.position);
    const type = normType(pick(raw, F.type));
    const image = pick(raw, F.image);
    const thumb = pick(raw, F.thumb, image);
    return { id, name, rarity, batch, club, position, type, image, thumb, _raw: raw };
  }

  // ==== RENDERING ===========================================================
  const state = { all: [], filt: [], page: 0, sort: 'rarity-desc' };

  function applyFilters(){
    const q = qs('#q').value.trim().toLowerCase();
    const rarity = qs('#rarity').value;
    const type = qs('#type').value;
    const batch = qs('#batch').value;
    const club = qs('#club').value;

    state.page = 0;
    state.filt = state.all.filter(it => {
      if (q && !it.__hay.includes(q)) return false;
      if (rarity && it.rarity !== rarity) return false;
      if (type) {
        if (['GK','OT'].includes(type)) {
          if (!(it.type === 'GK' || it.type === 'OT')) return false;
          if (it.type !== type) return false;
        } else if (['Speed','Technical','Physical'].includes(type)) {
          if (it.type !== type) return false;
        }
      }
      if (batch && it.batch !== batch) return false;
      if (club && it.club !== club) return false;
      return true;
    });

    sortItems();
    renderChunk(true);
    updateStats();
  }

  function sortItems(){
    const s = state.sort;
    const ord = ['SSR','SR','AR','R','N'];
    const cmp = {
      'rarity-desc': (a,b)=> ord.indexOf(a.rarity) - ord.indexOf(b.rarity) || toStr(a.name).localeCompare(toStr(b.name)),
      'name-asc':   (a,b)=> toStr(a.name).localeCompare(toStr(b.name)) || ord.indexOf(a.rarity) - ord.indexOf(b.rarity),
      'club-asc':   (a,b)=> toStr(a.club).localeCompare(toStr(b.club)) || toStr(a.name).localeCompare(toStr(b.name)),
      'batch-asc':  (a,b)=> toStr(a.batch).localeCompare(toStr(b.batch)) || toStr(a.name).localeCompare(toStr(b.name)),
      'id-asc':     (a,b)=> toStr(a.id).localeCompare(toStr(b.id))
    }[s] || ((a,b)=>0);
    state.filt.sort(cmp);
  }

  function updateStats(){
    const s = qs('#stats');
    if (!s) return;
    const total = state.all.length;
    const shown = state.filt.length;
    const byRar = groupCount(state.filt, 'rarity');
    const chips = Object.entries(byRar).sort((a,b)=>rarOrder(b[0])-rarOrder(a[0]))
      .map(([r,c])=>`<span class=\"ml-2\">${rarityEmoji(r)} <span class=\"text-neutral-200\">${r}</span> ${c}</span>`).join('');
    s.innerHTML = `<span class="text-neutral-300">${shown}</span>/<span>${total}</span> cards ${chips}`;
  }

  function rarOrder(r){ return ['SSR','SR','AR','R','N'].indexOf(r); }

  function groupCount(arr, key){
    const m = {};
    for (const it of arr){ const k = it[key] || ''; m[k] = (m[k]||0)+1; }
    return m;
  }

  function renderChunk(reset=false){
    const grid = qs('#grid');
    if (reset) grid.innerHTML = '';

    const start = state.page * CONFIG.PAGE_SIZE;
    const slice = state.filt.slice(start, start + CONFIG.PAGE_SIZE);

    for (const it of slice){ grid.appendChild(renderCard(it)); }

    state.page++;
  }

  function renderCard(it){
    const tpl = qs('#cardTpl').content.cloneNode(true);
    const root = tpl.querySelector('article');
    const img = tpl.querySelector('img');
    const chips = tpl.querySelector('div.absolute');
    const title = tpl.querySelector('h3');
    const sub = tpl.querySelector('p');
    const badge = tpl.querySelector('.badge');
    const openBtn = tpl.querySelector('button');
    const copyBtn = tpl.querySelector('.copy-id');

    img.loading = 'lazy';
    img.decoding = 'async';
    img.src = it.thumb || it.image || '';
    img.alt = `${it.name} â€” ${it.rarity}`;
    img.onerror = () => { img.src = placeholder(it); };

    title.textContent = it.name || it.id || 'Unknown';
    sub.textContent = [it.club, it.position || it.type, it.batch].filter(Boolean).join(' â€¢ ');
    badge.textContent = it.id || '';

    // chips: rarity + type + batch (compact)
    chips.appendChild(makeChip(`${rarityEmoji(it.rarity)} ${it.rarity}`));
    if (it.type) chips.appendChild(makeChip(it.type));
    if (it.batch) chips.appendChild(makeChip(it.batch));

    openBtn.addEventListener('click', () => openModal(it));

    // copy ID footer
    copyBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      try { await navigator.clipboard.writeText(it.id || ''); showToast(); } catch(_) {}
    });
    copyBtn.textContent = (it.id ? `Copy ID: ${it.id}` : 'Copy ID');

    return root;
  }

  function placeholder(it){
    const col = ({SSR:'#f5d90a', SR:'#f59f0b', AR:'#a78bfa', R:'#60a5fa', N:'#e5e7eb'})[it.rarity] || '#94a3b8';
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='840'>\n<defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='${col}' stop-opacity='.25'/><stop offset='1' stop-color='#111827' stop-opacity='.9'/></linearGradient></defs>\n<rect width='100%' height='100%' fill='url(#g)'/>\n<text x='50%' y='50%' text-anchor='middle' fill='white' font-size='28' font-family='Inter, Arial' opacity='.8'>${(it.name||'Unknown').replace(/</g,'&lt;')}</text>\n</svg>`);
    return `data:image/svg+xml;charset=utf-8,${svg}`;
  }

  // ==== MODAL ===============================================================
  function openModal(it){
    const m = qs('#modal');
    qs('#modalTitle').textContent = `${it.name || it.id} â€” ${it.rarity}`;
    qs('#modalImg').src = it.image || it.thumb || placeholder(it);
    const chips = qs('#modalChips');
    chips.innerHTML = '';
    for (const [k,v] of Object.entries({ID:it.id, Rarity:it.rarity, Batch:it.batch, Club:it.club, Position:it.position, Type:it.type})){
      if (!v) continue; chips.appendChild(makeChip(`${k}: ${v}`));
    }
    qs('#modalJson').textContent = JSON.stringify(it._raw ?? it, null, 2);
    m.showModal();
  }
  qs('#closeModal').addEventListener('click', ()=>qs('#modal').close());

  // ==== PAGINATION VIA INTERSECTION OBSERVER ================================
  const io = new IntersectionObserver((entries)=>{
    for (const e of entries){
      if (e.isIntersecting) {
        const maxPages = Math.ceil(state.filt.length / CONFIG.PAGE_SIZE);
        if (state.page < maxPages) renderChunk(false);
      }
    }
  }, { rootMargin: '800px 0px' });

  function renderLegend(){
    const root = qs('#legend');
    const rarOrder = ['SSR','SR','AR','R','N'];
    root.innerHTML = '';
    for (const r of rarOrder){
      const box = document.createElement('div');
      box.className = 'rounded-xl border border-neutral-800 bg-neutral-950 p-3';
      box.innerHTML = `
        <div class="text-sm font-semibold">${rarityEmoji(r)} ${r}</div>
        <div class="text-xs text-neutral-400 mt-1">Craft: <span class="text-neutral-200">${CONFIG.CRAFT[r] ?? '-'}</span></div>
        <div class="text-xs text-neutral-400">Sell: <span class="text-neutral-200">${CONFIG.SELL[r] ?? '-'}</span></div>
      `;
      root.appendChild(box);
    }
  }

  function populateClubFilter(){
    const sel = qs('#club');
    const clubs = uniqSorted(state.all.map(x=>x.club));
    for (const c of clubs){
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c; sel.appendChild(opt);
    }
  }

  // ==== WIRE-UP =============================================================
  ['#q','#rarity','#type','#batch','#club'].forEach(sel => qs(sel).addEventListener('input', applyFilters));
  qs('#resetBtn').addEventListener('click', () => {
    ['#q','#rarity','#type','#batch','#club'].forEach(sel => qs(sel).value = '');
    qs('#sort').value = 'rarity-desc';
    state.sort = 'rarity-desc';
    applyFilters();
  });
  qs('#sort').addEventListener('change', (e)=>{ state.sort = e.target.value; sortItems(); renderChunk(true); });

  (async function init(){
    try {
      const all = await fetchDex();
      state.all = all;
      buildQueryIndex(state.all);
      populateClubFilter();
      state.sort = qs('#sort').value;
      applyFilters();
      io.observe(qs('#sentinel'));
      renderLegend();
    } catch (err) {
      console.error(err);
      qs('#grid').innerHTML = `
        <div class="rounded-2xl bg-red-500/10 text-red-300 border border-red-800 p-4">
          <div class="font-semibold">Failed to load dex</div>
          <div class="text-sm opacity-90 mt-1">${err.message}</div>
          <div class="text-xs opacity-70 mt-2">Ensure your Cloudflare Worker exposes one of: <code>/api/dex</code>, <code>/api/cards</code>, <code>/api?op=dex</code>, or <code>/api?op=cards</code>. This page calls same-origin by default.</div>
        </div>`;
    }
  })();
  </script>
</body>
</html>


