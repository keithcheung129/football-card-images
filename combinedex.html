<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLK – Card Dex</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--line:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .hdr{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .hdr h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;padding:12px 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:16px}
    .input,select{width:100%;background:#0b1220;border:1px solid #263042;color:var(--text);border-radius:10px;padding:10px;font-size:14px}
    #search {
      width: 160px;          /* make it shorter */
      display: inline-block; /* prevents it from stretching */
    }
    .btn{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.alt{background:#334155}
    .card{background:#0b1220;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .thumb{aspect-ratio:3/4;background:#060a12;display:block;width:100%;object-fit:cover}
    .meta{padding:10px}
    .meta .name{font-size:14px;font-weight:700}
    .meta .sub{font-size:12px;color:var(--muted)}
    .idline{font-size:11px;color:#cbd5e1;border-top:1px solid var(--line);padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .legend{margin:16px 0 8px; display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
    .legend .box{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px}
    .legend .title{font-weight:700; font-size:13px}
    .legend .kvs{font-size:12px; color:var(--muted); margin-top:4px}
    a{color:var(--accent2)}
    #imgPopup { position: fixed; display:none; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:9999; }
    #imgPopup img { max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    #imgPopup.closeable { cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hdr">
        <h1>TLK Card Dex <span class="muted">(all card categories)</span></h1>
        <div><a href="./inventory.html">← Back to Inventory</a></div>
      </div>

      <!-- Filters (populated from data) -->
      <div class="row">
        <input id="q" class="input" placeholder="Search name / club / ID..." />
        <select id="category" class="input"><option value="ALL">Category: ALL</option></select>
        <select id="rarity"  class="input"><option value="ALL">Rarity: ALL</option></select>
        <select id="position" class="input"><option value="ALL">Position: ALL</option></select>
        <select id="batch"   class="input"><option value="ALL">Batch: ALL</option></select>
        <select id="club"    class="input"><option value="ALL">Club: ALL</option></select>
        <select id="p_type"    class="input"><option value="ALL">Player Type: ALL</option></select>
        <select id="sortBy"  class="input">
          <option value="rarity_club" selected>Sort: Rarity</option>
          <option value="name">Name (A→Z)</option>
          <option value="club">Club</option>
          <option value="position">Position (GK→ST)</option>
          <option value="batch">Batch</option>
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
      </div>

      <!-- Legend (hard-code your figures below) -->
      <div class="legend" id="legend"></div>
      
      <!-- Grid -->
      <div id="dex" class="grid" aria-live="polite"></div>

      <!-- Footer -->
      <div class="hdr" style="border-top:1px solid var(--line); border-bottom:0;">
        <div class="muted" id="countInfo">0 cards</div>
        <div class="muted">Tip: filter dropdowns are populated from the sheet values.</div>
      </div>
    </div>



    <p class="muted" style="margin:12px 4px">Share a link like <code>?r=SSR&c=Arsenal</code> to prefill filters.</p>
  </div>

  <!-- Lightbox -->
  <div id="imgPopup" class="closeable"><img src="" alt="preview"></div>

<script>
// ====== CONFIG (same pattern as inventory) ======
const API_BASE = 'https://the-last-kick.keithcheung129.workers.dev/api';

// Reuse helpers/naming from inventory
const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
const qs = new URLSearchParams(location.search);

const RARITY_ORDER   = ["GOD","SSR","SR","AR","R","N","U","ALL"];
const POSITION_ORDER = ["GK","CB","RB","LB","DM","CM","AM","LW","RW","ST","MGR","STM","EVE","ALL"];
const U = (s) => String(s ?? "").toUpperCase();
const rank = (v, order) => { const i = order.indexOf(U(v)); return i === -1 ? 999 : i; };

// ---- API (one unfiltered call to get ALL cards) ----
async function callCollection(params = {}) {
  const res = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    // Important: first load sends ONLY {action:"cards"}
    body: JSON.stringify(Object.keys(params).length ? { action: 'cards', ...params } : { action: 'cards' })
  });
  const text = await res.text();
  if (!res.ok) throw new Error(`API ${res.status}: ${text.slice(0,500)}`);
  let body; try { body = JSON.parse(text); } catch { throw new Error('Bad JSON from API'); }
  return (body && typeof body === 'object' && 'ok' in body && 'data' in body) ? body.data : body;
}

// ---- state ----
let ALL = []; // normalized full list

// ---- normalize (use exact sheet fields) ----
function normalize(it) {
  return {
    card_id: it.card_id ?? it.printcode ?? it.code ?? '',
    name: it.name ?? it.player ?? '',
    rarity: it.rarity ?? '',
    category: it.type ?? '',         // player / manager / stadium / ...
    p_type: it.p_type ?? '',         // Phy / Spd / Tec (players)
    gko: it.gk_outfield ?? '',       // GK / OT
    position: it.position ?? '',
    club: it.club ?? '',
    batch: it.batch ?? it.set ?? '',
    image: it.image_ref ?? '',       // image_ref is the canonical column
    serial: it.serial ?? '',
    ts: Number(it.acquired_ts || it.acquiredAt || it.ts || 0),
    _raw: it
  };
}

// ---- populate filter dropdowns from data ----
function populateFilters(list) {
  const distinct = (key) => Array.from(new Set(list.map(x => (x[key] || '').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  function fill(selId, label, values, allValue="ALL") {
    const sel = $(selId); if (!sel) return;
    const cur = sel.value || allValue;
    sel.innerHTML = `<option value="${allValue}">${label}: ${allValue}</option>` +
                    values.map(v => `<option value="${v}">${v}</option>`).join('');
    if ([...sel.options].some(o => o.value === cur)) sel.value = cur;
  }

  fill('category','Category', distinct('category'));
  fill('rarity', 'Rarity', distinct('rarity'));
  fill('position','Position', distinct('position'));
  fill('batch',  'Batch', distinct('batch'));
  fill('club',   'Club', distinct('club'));
  fill('p_type','Player Type', distinct('p_type'));

  // p_type is only meaningful for players
  $('#p_type').disabled = ($('#category').value !== 'player' && $('#category').value !== 'ALL');
}

// ---- filtering (client-side only) ----
function applyFilters() {
  // --- read inputs safely (default to 'ALL')
  const q        = ( ($('#q')?.value || '').trim().toLowerCase() );
  const category = ($('#category')?.value || 'ALL');
  const p_type   = ($('#p_type')?.value || 'ALL');
  const rarity   = ($('#rarity')?.value || 'ALL');
  const position = ($('#position')?.value || 'ALL');
  const batch    = ($('#batch')?.value || 'ALL');
  const club     = ($('#club')?.value || 'ALL');
  const sortBy   = ($('#sortBy')?.value || 'rarity_club');

  // toggle Player Type control based on Category
  const catEl   = $('#category');
  const pTypeEl = $('#p_type');
  if (catEl && pTypeEl) {
    pTypeEl.disabled = (catEl.value !== 'player' && catEl.value !== 'ALL');
  }

  // --- filter client-side from ALL (normalized list)
  let items = (Array.isArray(ALL) ? ALL : []).filter(it => {
    if (q && !( (it.name || '').toLowerCase() + ' ' + (it.club || '').toLowerCase() + ' ' + (it.card_id || '').toLowerCase() ).includes(q)) return false;

  // new
  if (category !== 'ALL' && (it.category || '') !== category) return false;

  // If a Player Type is chosen, we implicitly restrict to players of that type
  if (p_type !== 'ALL') {
    if ((it.category || '') !== 'player') return false;
    if ((it.p_type   || '') !== p_type)   return false;
  }


    if (rarity   !== 'ALL' && (it.rarity   || '') !== rarity) return false;
    if (position !== 'ALL' && (it.position || '') !== position) return false;
    if (batch    !== 'ALL' && (it.batch    || '') !== batch) return false;
    if (club     !== 'ALL' && (it.club     || '') !== club) return false;

    return true;
  });

  // --- sort, render, counts
  items = sortItems(items, sortBy);
  render(items);
  const info = $('#countInfo');
  if (info) info.textContent = `${items.length} shown • ${Array.isArray(ALL) ? ALL.length : 0} total`;
}


// ---- sorting (same spirit as inventory) ----
function sortItems(items, mode) {
  items.sort((a, b) => {
    const ra = rank(a.rarity, RARITY_ORDER), rb = rank(b.rarity, RARITY_ORDER);
    const pa = rank(a.position, POSITION_ORDER), pb = rank(b.position, POSITION_ORDER);
    const ca = U(a.club), cb = U(b.club);
    const ba = U(a.batch), bb = U(b.batch);
    const na = (a.name || a.card_id).toString();
    const nb = (b.name || b.card_id).toString();
    const ta = a.ts, tb = b.ts;

    switch (mode) {
      case "rarity_asc": return rb - ra || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);
      case "club":       return ca.localeCompare(cb) || pa - pb || ra - rb || na.localeCompare(nb);
      case "position":   return pa - pb || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "batch":      return ba.localeCompare(bb) || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "name":       return na.localeCompare(nb);
      case "newest":     return tb - ta || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "oldest":     return ta - tb || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "rarity_club":
      default:           return ra - rb || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);
    }
  });
  return items;
}

// ---- render ----
function render(items) {
  const root = $('#dex');
  root.innerHTML = '';
  for (const it of items) {
    const card = document.createElement('div');
    card.className = 'card';

    const img = document.createElement('img');
    img.className = 'thumb';
    img.loading = 'lazy';
    img.src = it.image || '';
    img.alt = it.name || it.card_id || '';
    img.onerror = () => { img.style.background = '#0f172a'; img.src = ''; };
    img.addEventListener('click', () => openLightbox(img.src));
    card.appendChild(img);

    const meta = document.createElement('div');
    meta.className = 'meta';
    const nm = document.createElement('div');
    nm.className = 'name'; nm.textContent = it.name || it.card_id || '—';
    const sb = document.createElement('div');
    sb.className = 'sub';
    const bits = [it.rarity, it.category, it.gko || it.position, it.batch, it.club].filter(Boolean);
    sb.textContent = bits.join(' • ');
    meta.appendChild(nm); meta.appendChild(sb);
    card.appendChild(meta);

    const idline = document.createElement('div');
    idline.className = 'idline';
    idline.innerHTML = `card_id: <b>${it.card_id || ''}</b>`;
    const btn = document.createElement('button');
    btn.className = 'btn alt'; btn.textContent = 'Copy';
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      try { await navigator.clipboard.writeText(it.card_id || ''); btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent='Copy', 900); } catch {}
    });
    idline.appendChild(btn);
    card.appendChild(idline);

    root.appendChild(card);
  }
}

// ---- legend (hard-code figures here) ----
function renderLegend() {
  const L = {
    CRAFT: { N: 6, R: 10, AR: 20, SR: 60, SSR: 200 },
    SELL:  { N: 1,  R: 1,  AR: 3, SR: 8,  SSR: 30 }
  };
  const root = document.getElementById('legend');
  root.innerHTML = '';
  for (const r of ['SSR','SR','AR','R','N']) {
    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = `<div class="title">${r}</div>
      <div class="kvs">Craft: <b>${L.CRAFT[r] ?? '-'}</b><br>Sell: <b>${L.SELL[r] ?? '-'}</b></div>`;
    root.appendChild(box);
  }
}

// ---- lightbox ----
const popup = document.getElementById('imgPopup');
const popupImg = popup.querySelector('img');
function openLightbox(src){ if (!src) return; popupImg.src = src; popup.style.display='flex'; }
popup.addEventListener('click', () => { popup.style.display='none'; popupImg.src=''; });

// ---- wire up ----
function bindFilters() {
  const ids = ['q','category','p_type','rarity','position','batch','club','sortBy'];
  ids.forEach(id => $(id).addEventListener('input', () => {
    // enable/disable p_type dropdown depending on category
    $('#p_type').disabled = ($('#category').value !== 'player' && $('#category').value !== 'ALL');
    applyFilters();
  }));
}

(async function init(){
  try {
    renderLegend();
    const payload = await callCollection(); // ONLY {action:"cards"}
    const items = Array.isArray(payload.items) ? payload.items : (Array.isArray(payload) ? payload : []);
    ALL = items.map(normalize);

    // prefill from query string (optional)
    if (qs.get('r')) $('#rarity').value = qs.get('r');
    if (qs.get('p')) $('#position').value = qs.get('p');
    if (qs.get('b')) $('#batch').value = qs.get('b');
    if (qs.get('c')) $('#club').value = qs.get('c');
    if (qs.get('cat')) $('#category').value = qs.get('cat');

    populateFilters(ALL);
    bindFilters();
    applyFilters();
  } catch (err) {
    console.error(err);
    document.getElementById('dex').innerHTML =
      `<div style="padding:12px;color:#ef9a9a">Failed to load dex: ${err.message}</div>`;
  }
})();
</script>
</body>
</html>
