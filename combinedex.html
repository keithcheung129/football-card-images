<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLK – Card Dex</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--line:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .hdr{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .hdr h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;padding:12px 16px}
    .row .col-span-2{grid-column:span 2}
    .input,select{width:100%;background:#0b1220;border:1px solid #263042;color:var(--text);border-radius:10px;padding:10px;font-size:14px}
    .btn{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.alt{background:#334155}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:16px}
    .card{background:#0b1220;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .thumb{aspect-ratio:3/4;background:#060a12;display:block;width:100%;object-fit:cover}
    .meta{padding:10px}
    .meta .name{font-size:14px;font-weight:700}
    .meta .sub{font-size:12px;color:var(--muted)}
    .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap: 10px 12px; }
    .pill { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid rgba(255,255,255,0.12); border-radius:9999px; background:#0b1220; white-space:nowrap; }
    .pill select, .pill input[type="text"] { appearance: none; background: #0f172a; color: #fff; border: 0; outline: 0; height: 32px; line-height: 32px; padding: 0 10px; min-width: 120px; border-radius: 8px; }
    .pill select option, .pill select optgroup { background: #0b1220; color: #fff; }
    .pill select:focus, .pill input[type="text"]:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
    .btn, .btn-ghost { height:34px; line-height:34px; padding:0 12px; border-radius:10px; }
    @media (max-width: 820px) { .pill select, .pill input[type="text"] { min-width: 140px; } }
    .footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--line)}
    .page{display:flex;gap:8px;align-items:center}
    .page input{width:72px;text-align:center}
    .badge{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:8px 12px}
    .legend{margin:16px 0 8px; display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
    .legend .box{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px}
    .legend .box .title{font-weight:700; font-size:13px}
    .legend .kvs{font-size:12px; color:var(--muted); margin-top:4px}
    .idline{font-size:11px; color:#cbd5e1; border-top:1px solid var(--line); padding:8px 10px}
    a{color:var(--accent2)}
    /* Image popup (lightbox) */
    #imgPopup { position: fixed; display:none; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:9999; }
    #imgPopup img { max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    #imgPopup.closeable { cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hdr">
        <h1>TLK Card Dex <span class="muted">(all cards)</span></h1>
        <div><a href="./inventory.html">← Back to Inventory</a></div>
      </div>
      <div class="row" id="filters">
        <label class="pill">Rarity:
          <select id="rarity">
            <option value="ALL">Rarity: ALL</option>
            <option>N</option><option>R</option><option>AR</option><option>SR</option><option>SSR</option>
          </select>
        </label>
        <label class="pill">position:
          <select id="position">
            <option value="ALL">Position: ALL</option>
            <option>GK</option><option>RB</option><option>LB</option><option>CB</option><option>DM</option><option>CM</option><option>AM</option><option>RW</option><option>LW</option><option>ST</option>
          </select>
        </label>
        <label class="pill">batch:
          <select id="batch">
            <option value="ALL">Batch: ALL</option>
            <option value="Base">Base</option>
            <option value="Base U">Base U</option>
            <option value="Base SSR">Base SSR</option>
          </select>
        </label>
        <label class="pill">Club:
          <select id="club">
            <option value="ALL" selected>ALL</option>
          </select>
        </label>
        <label class="pill">Sort:
          <select id="sortBy">
            <option value="rarity_club" selected>Rarity</option>
            <option value="club">Club</option>
            <option value="position">Position (GK→ST)</option>
            <option value="name">Name (A→Z)</option>
            <option value="batch">Batch</option>
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            </select>
        </label>
        <div class="toolbar">
          <button class="btn" id="btnSearch">Search</button>
          <button class="btn alt" id="btnReset">Reset</button>
        </div>
      </div>

      <!-- Dex Grid -->
      <div id="dex" class="grid" aria-live="polite"></div>

      <div class="footer">
        <div class="muted" id="countInfo">0 cards</div>
        <div class="page">
          <button class="btn alt" id="prevBtn">Prev</button>
          <input id="page" class="input" value="1" />
          <span class="muted">/ <span id="pages">1</span></span>
          <select id="pageSize" class="input">
            <option>24</option><option selected>48</option><option>96</option>
          </select>
          <button class="btn alt" id="nextBtn">Next</button>
        </div>
      </div>
    </div>

    <!-- Economy legend (hard-code your figures below) -->
    <div class="legend" id="legend"></div>

    <p class="muted" style="margin:12px 4px">Tip: share a link like <code>?r=SSR&p=ST</code> to pre-fill filters.</p>
  </div>
  <div id="imgPopup" class="closeable"><img src="" alt="preview"></div>

<script>
// ======= CONFIG (same names as inventory) =======
const API_BASE   = 'https://the-last-kick.keithcheung129.workers.dev/api';
// const API_SECRET = '';

const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
const qs = new URLSearchParams(location.search);

// ---- helpers (same names) ----
const byId = (id) => { const el = document.getElementById(id); if (!el) console.warn(`Missing element #${id}`); return el; };
const val = (id, fallback = "") => (byId(id)?.value ?? fallback);
const chk = (id) => !!byId(id)?.checked; // kept for parity (not used here)

const RARITY_ORDER   = ["GOD","SSR","SR","AR","R","N","U","ALL"];
const POSITION_ORDER = ["GK","CB","RB","LB","DM","CM","AM","LW","RW","ST","MGR","STM","EVE","ALL"];
const U = (s) => String(s ?? "").toUpperCase();
const rank = (v, order) => { const i = order.indexOf(U(v)); return i === -1 ? 999 : i; };

function sortItems(items, mode) {
  items.sort((a, b) => {
    const ra = rank(a.rarity, RARITY_ORDER), rb = rank(b.rarity, RARITY_ORDER);
    const pa = rank(a.position, POSITION_ORDER), pb = rank(b.position, POSITION_ORDER);
    const ca = U(a.club), cb = U(b.club);
    const ba = U(a.batch), bb = U(b.batch);
    const na = (a.name || a.player || a.printcode || a.card_id || "").toString();
    const nb = (b.name || b.player || b.printcode || b.card_id || "").toString();
    const ta = Number(a.acquired_ts || a.acquiredAt || a.ts || 0);
    const tb = Number(b.acquired_ts || b.acquiredAt || b.ts || 0);
    switch (mode) {
      case "rarity_asc": return rb - ra || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);
      case "club":       return ca.localeCompare(cb) || pa - pb || ra - rb || na.localeCompare(nb);
      case "position":   return pa - pb || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "batch":      return ba.localeCompare(bb) || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "name":       return na.localeCompare(nb);
      case "newest":     return tb - ta || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "oldest":     return ta - tb || ra - rb || ca.localeCompare(cb) || na.localeCompare(nb);
      case "rarity_desc":
      default:            return ra - rb || ca.localeCompare(cb) || pa - pb || na.localeCompare(nb);
    }
  });
  return items;
}

function buildQuery() {
  return {
    // Dex shows ALL cards -> no user_id, no unique_only
    page: Math.max(1, parseInt(val("page", "1")) || 1),
    page_size: Math.max(1, parseInt(val("pageSize", "48")) || 48),
    rarity:   val("rarity",   "ALL") || "ALL",
    position: val("position", "ALL") || "ALL",
    batch:    val("batch",    "ALL") || "ALL",
    club:     val("club",     "ALL") || "ALL",
  };
}

function applyQS(){
  if(qs.get('r')) $('#rarity').value = qs.get('r');
  if(qs.get('p')) $('#position').value = qs.get('p');
  if(qs.get('b')) $('#batch').value = qs.get('b');
  if(qs.get('page')) $('#page').value = qs.get('page');
  if(qs.get('c')) $('#club').value = qs.get('c');
}

async function callCollection(params){
  // Same function name as inventory; here it calls the "cards" action
  const res = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'cards', ...params })
  });
  const text = await res.text();
  if (!res.ok) throw new Error(`API ${res.status}: ${text.slice(0,500)}`);
  let body; try { body = JSON.parse(text); } catch { throw new Error('Bad JSON from API'); }
  return (body && typeof body === 'object' && 'ok' in body && 'data' in body) ? body.data : body;
}

function render(items){
  const root = $('#dex');
  root.innerHTML = '';
  for(const it of items){
    const div = document.createElement('div');
    div.className='card';
    const img = document.createElement('img');
    img.className='thumb';
    img.loading='lazy';
    img.src = it.image_url || it.image_ref || '';
    img.alt = it.name || it.printcode || it.card_id || '';
    div.appendChild(img);

    const meta = document.createElement('div');
    meta.className='meta';
    const nm = document.createElement('div');
    nm.className='name'; nm.textContent = it.name || it.player || it.printcode || it.card_id || '—';
    const sb = document.createElement('div');
    sb.className='sub';
    const bits = [it.rarity, it.club, it.position, it.batch, it.serial?('#'+it.serial):null].filter(Boolean);
    sb.textContent = bits.join(' • ');
    meta.appendChild(nm); meta.appendChild(sb);
    div.appendChild(meta);

    // --- card ID footer (exact field name: card_id) ---
    const idline = document.createElement('div');
    idline.className = 'idline';
    const btn = document.createElement('button');
    btn.className = 'btn alt'; btn.style.marginLeft='8px'; btn.textContent = 'Copy';
    idline.textContent = `card_id: ${it.card_id ?? it.printcode ?? ''}`;
    btn.addEventListener('click', async (e)=>{ e.stopPropagation(); try{ await navigator.clipboard.writeText(it.card_id ?? it.printcode ?? ''); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy', 900);}catch{}});
    idline.appendChild(btn);
    div.appendChild(idline);

    enableImagePopup(img);
    root.appendChild(div);
  }
}

// --- Image popup ---
const popup = document.getElementById("imgPopup");
const popupImg = popup.querySelector("img");
function enableImagePopup(img) { img.addEventListener("click", () => { popupImg.src = img.src; popup.style.display = "flex"; }); }
popup.addEventListener("click", () => { popup.style.display = "none"; popupImg.src = ""; });

function updateCounts(total, page, pageSize){
  const pages = Math.max(1, Math.ceil(total / pageSize));
  $('#countInfo').textContent = `${total} card${total===1?'':'s'}`;
  $('#pages').textContent = pages;
  $('#page').value = Math.min(page, pages);
  $('#prevBtn').disabled = (page<=1);
  $('#nextBtn').disabled = (page>=pages);
}

function renderLegend(){
  const L = {
    // <-- hard-code your figures here
    CRAFT: { N: 10, R: 25, AR: 60, SR: 200, SSR: 800 },
    SELL:  { N: 2,  R: 6,  AR: 18, SR: 75,  SSR: 300 }
  };
  const root = document.getElementById('legend');
  root.innerHTML = '';
  const order = ['SSR','SR','AR','R','N'];
  for (const r of order){
    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = `<div class="title">${r}</div><div class="kvs">Craft: <b>${L.CRAFT[r] ?? '-'}</b><br>Sell: <b>${L.SELL[r] ?? '-'}</b></div>`;
    root.appendChild(box);
  }
}

async function search() {
  try {
    const q = buildQuery();
    const data = await callCollection(q); // same function name
    const items = (data.items || []).map(it => ({ ...it, printcode: it.printcode ?? it.card_id }));

    const total = Number(data.total ?? items.length);
    const sortMode = $('#sortBy').value || 'rarity_club';
    sortItems(items, sortMode);

    // Populate clubs dropdown from current results
    (function populateClubs(list){
      const sel = byId('club'); if (!sel) return; const cur = sel.value || 'ALL';
      const clubs = Array.from(new Set(list.map(it => (it.club || '').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = '<option value="ALL">ALL</option>' + clubs.map(c=>`<option>${c}</option>`).join('');
      if (Array.from(sel.options).some(o => o.value === cur)) sel.value = cur;
    })(items);

    render(items);
    updateCounts(total, Number($('#page').value || 1), Number($('#pageSize').value || 48));

    if (!items.length) {
      document.getElementById('dex').innerHTML = '<div style="padding:12px;opacity:.7">No cards match your filters.</div>';
    }

  } catch (err) {
    console.error(err);
    alert('Failed to load dex. Check API base in code.');
  }
}

// ---- Wire up ----
document.addEventListener('DOMContentLoaded', () => {
  const safeOn = (id, evt, fn) => { const el = document.getElementById(id); if (!el) { console.warn(`Missing #${id}`); return; } el.addEventListener(evt, fn); };

  applyQS();
  renderLegend();

  safeOn('btnSearch', 'click', () => { byId('page').value = 1; search(); });
  safeOn('btnReset',  'click', () => { location.href = location.pathname; });
  safeOn('prevBtn',   'click', () => { const cur = +(val('page','1')); byId('page').value = Math.max(1, cur - 1); search(); });
  safeOn('nextBtn',   'click', () => { const cur = +(val('page','1')); byId('page').value = cur + 1; search(); });
  safeOn('pageSize',  'change', () => { byId('page').value = 1; search(); });
  ['rarity','position','batch','club','sortBy'].forEach(id=>safeOn(id,'change',()=>{ byId('page').value = 1; search(); }));

  // auto-search on load
  search();
});
</script>
</body>
</html>
