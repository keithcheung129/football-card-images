<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TLK ‚Äì Formation Builder</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#38bdf8; --line:#1f2937;
    --cardW:96px; --cardH:135px;  /* adjust once and the pitch scales */
    --gap:12px;
    --pitchW: 720px; /* exact pitch width; adjust to taste */
    --pitchH: 850px;
    --sideInset: 20%;   /* ‚Üê move this to match your sketch */
    --topBoxTop: 0%;     /* distance from top edge to top box */
    --topBoxH: 30%;      /* height of top box */
    --botBoxBottom: 0%;  /* distance from bottom edge to bottom box */
    --botBoxH: 30%;      /* height of bottom box ‚Äì make this bigger for GK */
    --centreDia: 18%;    /* centre circle diameter */
    /* line strength (tweak colors/alpha to taste) */
    --lineSoft:  #e5e7eb66;   /* boxes */
    --lineWings: #e5e7eb66;   /* wing lines */
    --lineHalf:  #e5e7eb66;   /* half way */
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
  .hdr{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:12px}

  /* top controls */
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
  .input,select{background:#0b1220;border:1px solid #263042;color:var(--text);border-radius:10px;padding:8px 10px;font-size:14px}
  .btn{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.alt{background:#334155}
  .btn.danger{background:#b91c1c}

  /* main 2-column content: pitch left, inventory right */
  .content{
    display:grid; grid-template-columns: 1fr 360px; gap:14px; padding:12px 16px 16px 16px;
  }
  .side .inventory{ position:sticky; top:16px; max-height: calc(100vh - 150px); overflow:auto; border-left:1px solid var(--line); padding-left:14px }

  /* compact, dimmer pitch */
  .pitch-wrap{ display:flex; justify-content:center; }
  .pitch{
    width: var(--pitchW);               /* was calc(...) */
    height: var(--pitchH);              /* was calc(...) */
    background:#1a6b3c;                 /* dimmer green */
    border:2px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    position:relative;
  }
  .pitch .box-top{
    position:absolute; left:var(--sideInset); right:var(--sideInset);
    top:var(--topBoxTop); height:var(--topBoxH);
    border:2px solid var(--lineSoft); border-radius:6px;
  }
  .pitch .box-bot{
    position:absolute; left:var(--sideInset); right:var(--sideInset);
    bottom:var(--botBoxBottom); height:var(--botBoxH);
    border:2px solid var(--lineSoft); border-radius:6px;
  }
  .pitch .wing-left{
    position:absolute; top:0; bottom:0; left:var(--wingX);
    width:2px; background:var(--lineWings);
  }
  .pitch .wing-right{
    position:absolute; top:0; bottom:0; right:var(--wingX);
    width:2px; background:var(--lineWings);
  }
  .pitch .half{
    position:absolute; left:0; right:0; top:50%;
    height:3px; background:var(--lineHalf);
  }
  .pitch .centre{
    position:absolute; left:50%; top:50%;
    width:var(--centreDia); aspect-ratio:1/1; transform:translate(-50%,-50%);
    border:1px solid var(--lineHalf); border-radius:50%;
  }

  /* subtle field lines */

  /* slots */
  .slot{
    position:absolute; width:var(--cardW); height:var(--cardH);
    border:2px dashed #8A7FA6CC; border-radius:10px; display:flex; align-items:center; justify-content:center;
    text-align:center; padding:4px; box-sizing:border-box;
  }
  .slot.hover{ border-color:#38bdf8; box-shadow:0 0 0 3px #38bdf888 inset; }
  .slot.thumb{ width:100%; height:100%; object-fit:cover; border-radius:8px; display:none }
  .slot.filled .thumb{ display:block }
  .slot .lbl{ position:absolute; bottom:-16px; font-size:10px; color:#94a3b8 }
  /* hide slot labels but keep them in DOM for saving/loading */
  .slot .lbl{ display:none; }
  .slot.moveable{ cursor: move; }  /* when editing layout */
  #trash.hover{ outline:2px solid #ef4444; }  /* trash hover feedback */




  /* bench strip */
  .bench{display:flex; gap:8px; flex-wrap:wrap; padding:12px 16px}
  .bench .slot .lbl{ bottom:auto; top:-16px }
  .bench .slot{ position:relative; }

  /* inventory (side) */
  .filters{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(108px,1fr)); gap:10px}
  .card{background:#0b1220;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card[draggable="true"]{ cursor:grab }
  .card .thumb{aspect-ratio:3/4; width:100%; object-fit:cover; display:block}
  .card .meta{padding:6px 8px}
  .card .name{font-size:12px;font-weight:700}
  .card.dim{opacity:.35}
  .row-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}

  @media (max-width: 980px){
    .content{ grid-template-columns: 1fr; }
    .side .inventory{ position:relative; top:auto; max-height:none; border-left:0; padding-left:0; }
    .pitch{ width: calc(var(--cardW) * 5 + 40px); height: calc(var(--cardH) * 4 + 40px); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="hdr">
      <h1>TLK Formation Builder</h1>
      <div class="muted">Drag cards onto the pitch. No duplicates allowed. Right-click a slot to clear.</div>
    </div>

    <!-- Controls -->
    <div class="row">

      <!-- after -->
      <input id="user_id" class="input" placeholder="Discord ID (preferred) or @username" />

      <input id="fname" class="input" placeholder="Formation name (e.g., 433 ‚Äì Pressing)"/>
      <button class="btn" id="btnLoad">Load</button>
      <button class="btn alt" id="btnList">My Formations</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn alt" id="btnClear">Clear</button>
      <button class="btn alt" id="btnEdit">Edit Layout</button>
      <button class="btn alt" id="btnGrid">Snap: On</button>
    </div>

    <!-- Main 2-column area -->
    <div class="content">
      <main>
        <!-- Pitch -->
        <div class="pitch-wrap">
          <div id="pitch" class="pitch" aria-live="polite">
            <div class="half"></div>
            <div class="box-top"></div>
            <div class="box-bot"></div>
            <div class="wing-left"></div>
            <div class="wing-right"></div>
            <div class="centre"></div>
            <!-- Compact 4-3-3 layout (absolute in %) -->
            <!-- back line -->
            <div class="slot" data-slot="GK"  style="left:50%; top:92%; transform:translate(-50%,-50%)"><span class="lbl">GK</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="LB"  style="left:10%; top:70%; transform:translate(-50%,-50%)"><span class="lbl">LB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="CB" style="left:35%; top:78%; transform:translate(-50%,-50%)"><span class="lbl">LCB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="CB" style="left:65%; top:78%; transform:translate(-50%,-50%)"><span class="lbl">RCB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RB"  style="left:90%; top:70%; transform:translate(-50%,-50%)"><span class="lbl">RB</span><img class="thumb" alt=""/></div>
            <!-- midfield -->
            <div class="slot" data-slot="CM" style="left:30%; top:48%; transform:translate(-50%,-50%)"><span class="lbl">LCM</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="DM"  style="left:50%; top:58%; transform:translate(-50%,-50%)"><span class="lbl">CM</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="CM" style="left:70%; top:48%; transform:translate(-50%,-50%)"><span class="lbl">RCM</span><img class="thumb" alt=""/></div>
            <!-- forwards -->
            <div class="slot" data-slot="LW"  style="left:10%; top:30%; transform:translate(-50%,-50%)"><span class="lbl">LW</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="ST"  style="left:50%; top:18%; transform:translate(-50%,-50%)"><span class="lbl">ST</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RW"  style="left:90%; top:30%; transform:translate(-50%,-50%)"><span class="lbl">RW</span><img class="thumb" alt=""/></div>
          </div>
        </div>

        <!-- Manager + Bench -->
        <div class="bench" id="bench">
          <div class="slot" data-slot="MGR"><span class="lbl">Manager</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B1"><span class="lbl">B1</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B2"><span class="lbl">B2</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B3"><span class="lbl">B3</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B4"><span class="lbl">B4</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B5"><span class="lbl">B5</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B6"><span class="lbl">B6</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B7"><span class="lbl">B7</span><img class="thumb" alt=""/></div>
          <div id="trash" class="panel" style="margin:0 16px 16px 16px; padding:10px; text-align:center; border:1px dashed #64748b;">
            üóë Drag here to remove from pitch
          </div>
        </div>
      </main>

      <!-- Inventory side -->
      <aside class="side">
        <div class="inventory">
          <div class="filters">
            <select id="rarity"><option value="ALL">Rarity: ALL</option><option>N</option><option>R</option><option>AR</option><option>SR</option><option>SSR</option></select>
            <select id="position"><option value="ALL">Position: ALL</option><option>GK</option><option>RB</option><option>LB</option><option>CB</option><option>DM</option><option>CM</option><option>AM</option><option>RW</option><option>LW</option><option>ST</option></select>
            <select id="club"><option value="ALL">Club: ALL</option></select>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button class="btn" id="btnSearch">Load Inventory</button>
            <button class="btn alt" id="btnRefresh">Refresh</button>
          </div>
          <div id="inv" class="grid" aria-live="polite"></div>
          <div class="row-footer">
            <div class="muted">Placed: <span id="placedCount">0</span> / 20</div>
            <div class="muted">üéü <span id="tickets">‚Äì</span> ‚Ä¢ ü™ô <span id="tokens">‚Äì</span></div>
          </div>
        </div>
      </aside>
    </div>

  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_BASE = 'https://the-last-kick.keithcheung129.workers.dev/api';

/* ===== helpers ===== */
const $ = (id) => document.getElementById(id);
const safeOn = (id,evt,fn) => { const el=$(id); if(el) el.addEventListener(evt,fn); else console.warn('Missing #'+id); };
// safe value getter (never throws if the element is missing)
const v = (id, def='') => {
  const el = $(id);
  return (el && typeof el.value === 'string') ? el.value : def;
};

// event binder (guarded) ‚Äì defines `on()` and `safeOn()`
// so either name will work across your code
const on = (id, evt, fn) => {
  const el = $(id);
  if (el) el.addEventListener(evt, fn);
  else console.warn('Missing #' + id);
};


/* ===== Layout edit & grid snap config ===== */
let editingLayout = false;       // toggled by "Edit Layout"
let SNAP_GRID = true;            // toggled by "Snap: On/Off"
const GRID = { xStepPct: 2, yStepPct: 2 }; // snap step (% of pitch); tweak for finer/coarser grid

const snapPct = (pct, step) => Math.round(pct / step) * step;

// enable/disable slot-as-card dragging depending on mode
function setSlotDraggableForCards(slot){
  if (!editingLayout && slot.classList.contains('filled')) slot.setAttribute('draggable','true');
  else slot.removeAttribute('draggable');
}


  
/* ===== state ===== */
let INVENTORY = [];          // user inventory
let selectedCard = null;     // for tap-to-place on mobile
const placedSet = new Set(); // "card_id::serial?" to block duplicates

const keyOf = (it) => `${it.card_id}::${it.serial ?? ''}`;

/* ===== API ===== */
async function callApi(action, payload){
  const res = await fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action, ...payload })
  });
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  let body; try { body = JSON.parse(text); } catch { throw new Error('Bad JSON'); }
  return (body && typeof body==='object' && 'ok' in body && 'data' in body) ? body.data : body;
}

/* ===== inventory ===== */
async function loadInventory(){
  const user_id = v('user_id').trim();
  if (!user_id){ alert('Enter user ID first'); return; }
  const q = {
    user_id,
    page: 1,
    page_size: 240,
    unique_only: false,
    rarity:   v('rarity','ALL')   || 'ALL',
    position: v('position','ALL') || 'ALL',
    batch: 'ALL',
    club:     v('club','ALL')     || 'ALL'
  };
  const data = await callApi('collection', q);
  INVENTORY = (data.items || []).map(x => ({
    card_id: x.card_id, name: x.name, rarity: x.rarity, position: x.position,
    club: x.club, image: x.image_url, serial: x.serial, type: x.type
  }));

  // populate clubs (guarded)
  const clubs = Array.from(new Set(INVENTORY.map(i => i.club).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  if ($('#club')) $('#club').innerHTML = '<option value="ALL">Club: ALL</option>' + clubs.map(c=>`<option>${c}</option>`).join('');

  if ($('#tickets')) $('#tickets').textContent = data?.balances?.tickets ?? '0';
  if ($('#tokens'))  $('#tokens').textContent  = data?.balances?.tokens  ?? '0';

  renderInventory();
}


  
function renderInventory(){
  const root = $('inv'); if (!root) return;
  root.innerHTML = '';
  INVENTORY.forEach(it => {
    const card = document.createElement('div'); card.className='card'; card.setAttribute('draggable','true');

    // drag
    card.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', JSON.stringify(it));
      ev.dataTransfer.effectAllowed = 'copyMove';
      selectedCard = it;
    });

    // click-to-place
    card.addEventListener('click', ()=>{
      selectedCard = it;
      document.querySelectorAll('#inv .card').forEach(n=>n.style.outline='');
      card.style.outline='2px solid #38bdf8';
    });

    if (placedSet.has(keyOf(it))) card.classList.add('dim');

    card.innerHTML = `
      <img class="thumb" src="${it.image||''}" alt="${it.name||it.card_id||''}"/>
      <div class="meta">
        <div class="name">${it.name || it.card_id}</div>
        <div class="muted">${[it.rarity, it.position || it.type, it.club].filter(Boolean).join(' ‚Ä¢ ')}</div>
      </div>`;
    root.appendChild(card);
  });
}









/* ===== slots ===== */
const allSlots = () => Array.from(document.querySelectorAll('.slot'));

function attachDnD(){
  for (const slot of allSlots()){
    slot.addEventListener('dragover', (e)=>{ e.preventDefault(); slot.classList.add('hover'); });
    slot.addEventListener('dragleave', ()=> slot.classList.remove('hover'));
    slot.addEventListener('click', ()=>{
      if (!selectedCard) return;
      placeInSlot(slot, selectedCard);
    });
    slot.addEventListener('contextmenu', (e)=>{ e.preventDefault(); clearSlot(slot); markInventoryDim(); updatePlacedCount(); });
    // allow dragging a filled slot as a "card" source (when NOT editing layout)
    slot.addEventListener('dragstart', (e)=>{
      if (editingLayout || !slot.classList.contains('filled')) { e.preventDefault(); return; }
      const it = {
        card_id: slot.dataset.cardId,
        serial:  slot.dataset.serial===''? null : Number(slot.dataset.serial),
        image:   slot.querySelector('.thumb')?.src || ''
      };
      e.dataTransfer.setData('text/plain', JSON.stringify(it));
      e.dataTransfer.effectAllowed = 'move';
      slot.dataset.draggingFrom = '1';
    });
    slot.addEventListener('dragend', ()=> { delete slot.dataset.draggingFrom; });
    // in your existing drop handler for slots, replace the body with:
    slot.addEventListener('drop', (e)=>{
      e.preventDefault(); slot.classList.remove('hover');
      let it; try{ it = JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch{ it=null; }
      if (!it || !it.card_id) return;

      const src = document.querySelector('.slot[data-dragging-from="1"]'); // moving from another slot?
      if (src && src !== slot){
        if (slot.classList.contains('filled')){
          // swap: put target‚Äôs card back into the source
          const tCard = {
            card_id: slot.dataset.cardId,
            serial:  slot.dataset.serial===''? null : Number(slot.dataset.serial),
            image:   slot.querySelector('.thumb')?.src || ''
          };
          placeInSlot(src, tCard);
        } else {
          // pure move: clear the source
          clearSlot(src);
        }
      }
      placeInSlot(slot, it);
    });
  }
  const trash = document.getElementById('trash');
  if (trash){
    trash.addEventListener('dragover', (e)=>{ e.preventDefault(); trash.classList.add('hover'); });
    trash.addEventListener('dragleave', ()=> trash.classList.remove('hover'));
    trash.addEventListener('drop', (e)=>{
      e.preventDefault(); trash.classList.remove('hover');
      const src = document.querySelector('.slot[data-dragging-from="1"]');
      if (src) { clearSlot(src); markInventoryDim(); updatePlacedCount(); }
    });
  }
}

function placeInSlot(slot, it){
  const k = keyOf(it);
  const prevKey = slot.dataset.kEq || '';
  // block duplicates (unless re-placing the same card back into same slot)
  if (placedSet.has(k) && k !== prevKey){ shake(slot); return; }

  if (prevKey) placedSet.delete(prevKey);

  const img = slot.querySelector('.thumb');
  if (img) img.src = it.image || '';
  slot.classList.add('filled');
  slot.dataset.cardId = it.card_id;
  slot.dataset.serial = (it.serial ?? '');
  slot.dataset.kEq = k;
  setSlotDraggableForCards(slot);

  placedSet.add(k);
  markInventoryDim();
  updatePlacedCount();
}

function clearSlot(slot){
  const kPrev = slot.dataset.kEq;
  if (kPrev) placedSet.delete(kPrev);
  slot.dataset.cardId=''; slot.dataset.serial=''; slot.dataset.kEq='';
  const img = slot.querySelector('.thumb'); if (img) img.src='';
  slot.classList.remove('filled');
  setSlotDraggableForCards(slot);
}

function markInventoryDim(){
  const cards = Array.from(document.querySelectorAll('#inv .card'));
  cards.forEach((node, i)=>{
    const it = INVENTORY[i]; if (!it) return;
    if (placedSet.has(keyOf(it))) node.classList.add('dim'); else node.classList.remove('dim');
  });
}
function updatePlacedCount(){ const pc=$('placedCount'); if (pc) pc.textContent = placedSet.size; }
function shake(el){
  el.style.transition='transform .08s';
  el.style.transform='translateX(4px)';
  setTimeout(()=>el.style.transform='translateX(-4px)', 80);
  setTimeout(()=>el.style.transform='translateX(0)', 160);
}

/* ===== shapes: relabel only (keep same compact layout) ===== */
// align 4-3-3 to your initial slot labels so loading saved data works
//REMOVED NOW
  //const SHAPES = {
  //"4-3-3": ["GK","LB","LCB","RCB","RB","LCM","CM","RCM","LW","ST","RW"],
  //"4-2-3-1": ["GK","LB","LCB","RCB","RB","DM1","DM2","LAM","CAM","RAM","ST"],
  //"3-5-2": ["GK","LCB","CB","RCB","LM","LCM","CM","RCM","RM","ST1","ST2"],
  //"4-4-2": ["GK","LB","LCB","RCB","RB","LM","LCM","RCM","RM","ST1","ST2"]
//};
  
//function relabelForShape(){
  //const shapeSel = $('shape');
  //const labels = SHAPES[shapeSel ? shapeSel.value : '4-3-3'] || SHAPES["4-3-3"];
  //const pitchSlots = allSlots().filter(s => !s.closest('#bench'));
  //pitchSlots.forEach((s,i)=>{
    //clearSlot(s);
    //const lbl = s.querySelector('.lbl');
    //if (lbl) lbl.textContent = labels[i] || ('S'+(i+1));
   // s.dataset.slot = lbl ? lbl.textContent : (s.dataset.slot || ('S'+(i+1)));
  //});
 // placedSet.clear(); updatePlacedCount(); markInventoryDim();
//}

function toggleLayoutEdit(){
  editingLayout = !editingLayout;

  allSlots().forEach(s=>{
    s.classList.toggle('moveable', editingLayout);
    setSlotDraggableForCards(s); // disable card-drag while editing layout
    if (editingLayout){
      s.addEventListener('mousedown', startPan);
      s.addEventListener('touchstart', startPan, {passive:false});
    } else {
      s.removeEventListener('mousedown', startPan);
      s.removeEventListener('touchstart', startPan);
    }
  });

  const btn = document.getElementById('btnEdit');
  if (btn) btn.textContent = editingLayout ? 'Stop Editing' : 'Edit Layout';
}

function toggleSnap(){
  SNAP_GRID = !SNAP_GRID;
  const b = document.getElementById('btnGrid');
  if (b) b.textContent = SNAP_GRID ? 'Snap: On' : 'Snap: Off';
}

function startPan(e){
  if (!editingLayout) return;
  e.preventDefault();

  const slot = e.currentTarget;
  const pitch = document.getElementById('pitch');
  const rect = pitch.getBoundingClientRect();

  const pt = (ev)=>{ const p = ev.touches ? ev.touches[0] : ev; return {x:p.clientX-rect.left, y:p.clientY-rect.top}; };
  const start = pt(e);

  const curLeftPct = parseFloat(slot.style.left) || (slot.offsetLeft / pitch.clientWidth * 100);
  const curTopPct  = parseFloat(slot.style.top)  || (slot.offsetTop  / pitch.clientHeight * 100);
  const startLpx = curLeftPct/100 * pitch.clientWidth;
  const startTpx = curTopPct /100 * pitch.clientHeight;

  function move(ev){
    ev.preventDefault();
    const cur = pt(ev);
    let nx = startLpx + (cur.x - start.x);
    let ny = startTpx + (cur.y - start.y);

    const halfW = slot.offsetWidth/2, halfH = slot.offsetHeight/2;
    nx = Math.max(halfW, Math.min(nx, pitch.clientWidth  - halfW));
    ny = Math.max(halfH, Math.min(ny, pitch.clientHeight - halfH));

    let nxPct = (nx / pitch.clientWidth)  * 100;
    let nyPct = (ny / pitch.clientHeight) * 100;

    if (SNAP_GRID){
      nxPct = snapPct(nxPct, GRID.xStepPct);
      nyPct = snapPct(nyPct, GRID.yStepPct);
    }

    slot.style.left = nxPct + '%';
    slot.style.top  = nyPct + '%';
    slot.style.transform = 'translate(-50%,-50%)';
  }
  function end(){
    window.removeEventListener('mousemove', move);
    window.removeEventListener('mouseup', end);
    window.removeEventListener('touchmove', move);
    window.removeEventListener('touchend', end);
  }

  window.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);
  window.addEventListener('touchmove', move, {passive:false});
  window.addEventListener('touchend', end);
}

  
/* ===== save / load ===== */
function collectSlots(){
  const pitch = document.getElementById('pitch');
  return allSlots().map(s=>{
    const cid = s.dataset.cardId || null;
    const ser = s.dataset.serial || '';
    const leftPct = parseFloat(s.style.left) || (s.offsetLeft / pitch.clientWidth * 100);
    const topPct  = parseFloat(s.style.top)  || (s.offsetTop  / pitch.clientHeight * 100);
    return {
      slot_id: (s.dataset.slot || s.querySelector('.lbl')?.textContent || '').trim(),
      card_id: cid,
      serial:  ser==='' ? null : Number(ser),
      x_pct:   +leftPct.toFixed(2),
      y_pct:   +topPct.toFixed(2)
    };
  });
}


async function saveFormation(){
  const user_id = v('user_id').trim();
  const name    = v('fname').trim();
  if (!user_id || !name){ alert('user id + formation name required'); return; }
  //const shape = v('shape','4-3-3') || '4-3-3';
  const slots = collectSlots();
  await callApi('formation_save', { user_id, name, shape, slots });
  alert('Saved ‚úî');
}

async function loadFormation(){
  const user_id = v('user_id').trim();
  const name    = v('fname').trim();
  if (!user_id || !name){ alert('enter user id & formation name to load'); return; }
  const data = await callApi('formation_get', { user_id, name });
  if (data?.error){ alert('Not found'); return; }

  //if ($('#shape')) $('#shape').value = data.shape || '4-3-3';
  // relabelForShape();
  placedSet.clear();
  allSlots().forEach(clearSlot);

  if (typeof s.x_pct === 'number' && typeof s.y_pct === 'number'){
    slotEl.style.left = s.x_pct + '%';
    slotEl.style.top  = s.y_pct + '%';
    slotEl.style.transform = 'translate(-50%,-50%)';
  }


  (data.slots || []).forEach(s=>{
    const slotEl = allSlots().find(x => String(x.dataset.slot)===String(s.slot_id));
    if (!slotEl || !s.card_id) return;
    const meta = INVENTORY.find(it => it.card_id===s.card_id && String(it.serial ?? '')===String(s.serial ?? ''));
    const img = slotEl.querySelector('.thumb');
    if (img && meta && meta.image) img.src = meta.image;
    slotEl.classList.add('filled');
    slotEl.dataset.cardId = s.card_id;
    slotEl.dataset.serial = (s.serial ?? '');
    slotEl.dataset.kEq = `${s.card_id}::${s.serial ?? ''}`;
    placedSet.add(slotEl.dataset.kEq);
  });

  updatePlacedCount(); markInventoryDim();
}

async function listFormations(){
  const user_id = v('user_id').trim();
  if (!user_id){ alert('enter user id first'); return; }
  const data = await callApi('formation_list', { user_id });
  if (!data.items?.length){ alert('No saved formations'); return; }
  alert('Saved formations:\n' + data.items.map(x=>`${x.name} ‚Äî ${new Date(x.ts).toLocaleString()}`).join('\n'));
}

function clearAll(){
  allSlots().forEach(clearSlot);
  placedSet.clear(); updatePlacedCount(); markInventoryDim();
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const u = new URLSearchParams(location.search).get('u');
  if (u && $('user_id')) $('user_id').value = u;

  attachDnD();
  on('btnSearch','click', loadInventory);
  on('btnRefresh','click', renderInventory);
  on('btnSave','click',    saveFormation);
  on('btnLoad','click',    loadFormation);
  on('btnList','click',    listFormations);
  on('btnClear','click',   clearAll);
  //on('shape','change',     relabelForShape);
  on('btnEdit','click', toggleLayoutEdit);
  on('btnGrid','click', toggleSnap);

});
</script>

</body>
</html>
