<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TLK â€“ Formation Builder</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#38bdf8; --line:#1f2937;
    --cardW:74px; --cardH:104px;  /* adjust once and the pitch scales */
    --gap:12px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
  .hdr{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:12px}

  /* top controls */
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
  .input,select{background:#0b1220;border:1px solid #263042;color:var(--text);border-radius:10px;padding:8px 10px;font-size:14px}
  .btn{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.alt{background:#334155}
  .btn.danger{background:#b91c1c}

  /* main 2-column content: pitch left, inventory right */
  .content{
    display:grid; grid-template-columns: 1fr 360px; gap:14px; padding:12px 16px 16px 16px;
  }
  .side .inventory{ position:sticky; top:16px; max-height: calc(100vh - 150px); overflow:auto; border-left:1px solid var(--line); padding-left:14px }

  /* compact, dimmer pitch */
  .pitch-wrap{ display:flex; justify-content:center; }
  .pitch{
    /* one-card margins for wings, and a compact 3-column lane for slots */
    width: calc(var(--cardW) * 5 + 56px);    /* = 1W margin + 3 cols + 1W margin + small padding */
    height: calc(var(--cardH) * 4 + 56px);   /* = top box (2H) + midfield (2H), small padding */
    background:#09170b;                      /* dimmer green */
    border:1px solid var(--line); border-radius:14px; overflow:hidden; position:relative;
  }
  /* subtle field lines */
  .pitch::before, .pitch::after{content:""; position:absolute; left:0; right:0; height:1px; background:#e5e7eb1a}
  .pitch::before{ top:28%; }  /* not exact to real pitch, purely decorative */
  .pitch::after{  top:72%; }

  /* slots */
  .slot{
    position:absolute; width:var(--cardW); height:var(--cardH);
    border:1px dashed #94a3b844; border-radius:10px; display:flex; align-items:center; justify-content:center;
    text-align:center; padding:4px; box-sizing:border-box;
  }
  .slot.hover{ border-color:var(--accent2); box-shadow:0 0 0 2px #38bdf855 inset; }
  .slot .thumb{ width:100%; height:100%; object-fit:cover; border-radius:8px; display:none }
  .slot.filled .thumb{ display:block }
  .slot .lbl{ position:absolute; bottom:-16px; font-size:10px; color:#94a3b8 }

  /* bench strip */
  .bench{display:flex; gap:8px; flex-wrap:wrap; padding:12px 16px}
  .bench .slot{ position:relative; static:relative }
  .bench .slot .lbl{ bottom:auto; top:-16px }

  /* inventory (side) */
  .filters{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(108px,1fr)); gap:10px}
  .card{background:#0b1220;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card[draggable="true"]{ cursor:grab }
  .card .thumb{aspect-ratio:3/4; width:100%; object-fit:cover; display:block}
  .card .meta{padding:6px 8px}
  .card .name{font-size:12px;font-weight:700}
  .card.dim{opacity:.35}
  .row-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}

  @media (max-width: 980px){
    .content{ grid-template-columns: 1fr; }
    .side .inventory{ position:relative; top:auto; max-height:none; border-left:0; padding-left:0; }
    .pitch{ width: calc(var(--cardW) * 5 + 40px); height: calc(var(--cardH) * 4 + 40px); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="hdr">
      <h1>TLK Formation Builder</h1>
      <div class="muted">Drag cards onto the pitch. No duplicates allowed. Right-click a slot to clear.</div>
    </div>

    <!-- Controls -->
    <div class="row">

      <!-- after -->
      <input id="user_id" class="input" placeholder="Discord ID (preferred) or @username" />

      <select id="shape" class="input">
        <option value="4-3-3" selected>4-3-3</option>
        <option value="4-2-3-1">4-2-3-1</option>
        <option value="3-5-2">3-5-2</option>
        <option value="4-4-2">4-4-2</option>
      </select>
      <input id="fname" class="input" placeholder="Formation name (e.g., 433 â€“ Pressing)"/>
      <button class="btn" id="btnLoad">Load</button>
      <button class="btn alt" id="btnList">My Formations</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn alt" id="btnClear">Clear</button>
    </div>

    <!-- Main 2-column area -->
    <div class="content">
      <main>
        <!-- Pitch -->
        <div class="pitch-wrap">
          <div id="pitch" class="pitch" aria-live="polite">
            <!-- Compact 4-3-3 layout (absolute in %) -->
            <!-- back line -->
            <div class="slot" data-slot="GK"  style="left:50%; top:88%; transform:translate(-50%,-50%)"><span class="lbl">GK</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="LB"  style="left:22%; top:70%; transform:translate(-50%,-50%)"><span class="lbl">LB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="LCB" style="left:38%; top:76%; transform:translate(-50%,-50%)"><span class="lbl">LCB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RCB" style="left:62%; top:76%; transform:translate(-50%,-50%)"><span class="lbl">RCB</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RB"  style="left:78%; top:70%; transform:translate(-50%,-50%)"><span class="lbl">RB</span><img class="thumb" alt=""/></div>
            <!-- midfield -->
            <div class="slot" data-slot="LCM" style="left:38%; top:53%; transform:translate(-50%,-50%)"><span class="lbl">LCM</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="CM"  style="left:50%; top:48%; transform:translate(-50%,-50%)"><span class="lbl">CM</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RCM" style="left:62%; top:53%; transform:translate(-50%,-50%)"><span class="lbl">RCM</span><img class="thumb" alt=""/></div>
            <!-- forwards -->
            <div class="slot" data-slot="LW"  style="left:22%; top:28%; transform:translate(-50%,-50%)"><span class="lbl">LW</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="ST"  style="left:50%; top:22%; transform:translate(-50%,-50%)"><span class="lbl">ST</span><img class="thumb" alt=""/></div>
            <div class="slot" data-slot="RW"  style="left:78%; top:28%; transform:translate(-50%,-50%)"><span class="lbl">RW</span><img class="thumb" alt=""/></div>
          </div>
        </div>

        <!-- Manager + Bench -->
        <div class="bench" id="bench">
          <div class="slot" data-slot="MGR"><span class="lbl">Manager</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B1"><span class="lbl">B1</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B2"><span class="lbl">B2</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B3"><span class="lbl">B3</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B4"><span class="lbl">B4</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B5"><span class="lbl">B5</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B6"><span class="lbl">B6</span><img class="thumb" alt=""/></div>
          <div class="slot" data-slot="B7"><span class="lbl">B7</span><img class="thumb" alt=""/></div>
        </div>
      </main>

      <!-- Inventory side -->
      <aside class="side">
        <div class="inventory">
          <div class="filters">
            <select id="rarity"><option value="ALL">Rarity: ALL</option><option>N</option><option>R</option><option>AR</option><option>SR</option><option>SSR</option></select>
            <select id="position"><option value="ALL">Position: ALL</option><option>GK</option><option>RB</option><option>LB</option><option>CB</option><option>DM</option><option>CM</option><option>AM</option><option>RW</option><option>LW</option><option>ST</option></select>
            <select id="club"><option value="ALL">Club: ALL</option></select>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button class="btn" id="btnSearch">Load Inventory</button>
            <button class="btn alt" id="btnRefresh">Refresh</button>
          </div>
          <div id="inv" class="grid" aria-live="polite"></div>
          <div class="row-footer">
            <div class="muted">Placed: <span id="placedCount">0</span> / 20</div>
            <div class="muted">ðŸŽŸ <span id="tickets">â€“</span> â€¢ ðŸª™ <span id="tokens">â€“</span></div>
          </div>
        </div>
      </aside>
    </div>

  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_BASE = 'https://the-last-kick.keithcheung129.workers.dev/api';

/* ===== helpers ===== */
const $ = (id) => document.getElementById(id);
const safeOn = (id,evt,fn) => { const el=$(id); if(el) el.addEventListener(evt,fn); else console.warn('Missing #'+id); };

/* ===== state ===== */
let INVENTORY = [];             // entire inventory (filtered by API params)
let selectedCard = null;        // for tap-to-place on mobile
const placedSet = new Set();    // keys: "card_id::serial?" â€” prevents duplicates

function keyOf(it){ return `${it.card_id}::${it.serial ?? ''}`; }

/* ===== API ===== */
async function callApi(action, payload){
  const res = await fetch(API_BASE, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action, ...payload })
  });
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  let body; try{ body = JSON.parse(text);}catch{ throw new Error('Bad JSON');}
  return (body && typeof body==='object' && 'ok' in body && 'data' in body) ? body.data : body;
}

/* ===== inventory ===== */
async function loadInventory(){
  const user_id = $('#user_id').value.trim();
  if (!user_id){ alert('Enter user ID first'); return; }
  const q = {
    user_id,
    page:1, page_size:240, unique_only:false,
    rarity: $('#rarity').value || 'ALL',
    position: $('#position').value || 'ALL',
    batch: 'ALL',
    club: $('#club').value || 'ALL'
  };
  const data = await callApi('collection', q);
  INVENTORY = (data.items || []).map(x=>({
    card_id:x.card_id, name:x.name, rarity:x.rarity, position:x.position,
    club:x.club, image:x.image_url, serial:x.serial, type:x.type
  }));

  // populate clubs
  const clubs = Array.from(new Set(INVENTORY.map(i=>i.club).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  $('#club').innerHTML = '<option value="ALL">Club: ALL</option>' + clubs.map(c=>`<option>${c}</option>`).join('');

  $('#tickets').textContent = data?.balances?.tickets ?? '0';
  $('#tokens').textContent  = data?.balances?.tokens ?? '0';

  renderInventory();
}
function renderInventory(){
  const root = $('#inv'); root.innerHTML = '';
  INVENTORY.forEach((it, idx)=>{
    const card = document.createElement('div'); card.className='card'; card.setAttribute('draggable','true');

    // drag support
    card.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', JSON.stringify(it));
      ev.dataTransfer.effectAllowed = 'copyMove';
      selectedCard = it; // also set click selection for convenience
    });

    // click-to-place (mobile)
    card.addEventListener('click', ()=>{
      selectedCard = it;
      // visual pick
      Array.from(document.querySelectorAll('.card')).forEach(n=>n.style.outline='');
      card.style.outline='2px solid #38bdf8';
    });

    if (placedSet.has(keyOf(it))) card.classList.add('dim');

    const img = document.createElement('img'); img.className='thumb'; img.src = it.image || ''; img.alt = it.name || it.card_id;
    const meta = document.createElement('div'); meta.className='meta';
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = it.name || it.card_id;
    const sb = document.createElement('div'); sb.className='muted'; sb.textContent = [it.rarity, it.position || it.type, it.club].filter(Boolean).join(' â€¢ ');

    meta.appendChild(nm); meta.appendChild(sb);
    card.appendChild(img); card.appendChild(meta);
    root.appendChild(card);
  });
}

/* ===== slots ===== */
function allSlots(){ return Array.from(document.querySelectorAll('.slot')); }

function attachDnD(){
  for (const slot of allSlots()){
    // drag over/drop
    slot.addEventListener('dragover', (e)=>{ e.preventDefault(); slot.classList.add('hover'); });
    slot.addEventListener('dragleave', ()=> slot.classList.remove('hover'));
    slot.addEventListener('drop', (e)=>{
      e.preventDefault(); slot.classList.remove('hover');
      let it; try{ it = JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch{ it=null; }
      if (!it || !it.card_id) return;
      placeInSlot(slot, it);
    });

    // click-to-place (if a card is selected)
    slot.addEventListener('click', ()=>{
      if (!selectedCard) return;
      placeInSlot(slot, selectedCard);
    });

    // right-click to clear
    slot.addEventListener('contextmenu', (e)=>{ e.preventDefault(); clearSlot(slot); markInventoryDim(); updatePlacedCount(); });
  }
}

function placeInSlot(slot, it){
  const k = keyOf(it);
  // duplicates not allowed across all slots
  const prevKey = slot.dataset.kEq || '';
  if (placedSet.has(k) && k !== prevKey){ shake(slot); return; }

  // free previous (if any)
  if (prevKey) placedSet.delete(prevKey);

  // set
  const img = slot.querySelector('.thumb');
  if (img) img.src = it.image || '';
  slot.classList.add('filled');
  slot.dataset.cardId = it.card_id;
  slot.dataset.serial = (it.serial ?? '');
  slot.dataset.kEq = k;

  placedSet.add(k);
  markInventoryDim();
  updatePlacedCount();
}

function clearSlot(slot){
  const kPrev = slot.dataset.kEq;
  if (kPrev) placedSet.delete(kPrev);
  slot.dataset.cardId=''; slot.dataset.serial=''; slot.dataset.kEq='';
  const img = slot.querySelector('.thumb'); if (img) img.src='';
  slot.classList.remove('filled');
}

function markInventoryDim(){
  const cards = Array.from(document.querySelectorAll('#inv .card'));
  cards.forEach((node, i)=>{
    const it = INVENTORY[i]; if (!it) return;
    if (placedSet.has(keyOf(it))) node.classList.add('dim'); else node.classList.remove('dim');
  });
}
function updatePlacedCount(){ $('#placedCount').textContent = placedSet.size; }
function shake(el){
  el.style.transition='transform .08s';
  el.style.transform='translateX(4px)';
  setTimeout(()=>el.style.transform='translateX(-4px)', 80);
  setTimeout(()=>el.style.transform='translateX(0)', 160);
}

/* ===== formation shapes: relabel only (keep positions compact) ===== */
const SHAPES = {
  "4-3-3": ["GK","LB","CB","CB","RB","CM","DM","CM","LW","ST","RW"],
  "4-2-3-1": ["GK","LB","CB","CB","RB","CM","CM","LW","AM","RW","ST"],
  "3-5-2": ["GK","CB","CB","CB","LB","CM","CM","CM","RB","ST","ST"],
  "4-4-2": ["GK","LB","CB","CB","RB","LW","CM","CM","RW","ST","ST"]
};
function relabelForShape(){
  const labels = SHAPES[$('#shape').value] || SHAPES["4-3-3"];
  const pitchSlots = allSlots().filter(s => !s.closest('#bench'));
  // clear pitch when switching shape
  pitchSlots.forEach((s,i)=>{
    clearSlot(s);
    const lbl = s.querySelector('.lbl'); if (lbl) lbl.textContent = labels[i] || ('S'+(i+1));
    s.dataset.slot = lbl ? lbl.textContent : s.dataset.slot;
  });
  placedSet.clear(); updatePlacedCount(); markInventoryDim();
}

/* ===== save / load ===== */
function collectSlots(){
  return allSlots().map(s=>{
    const cid = s.dataset.cardId || null;
    const ser = s.dataset.serial || '';
    return { slot_id: (s.dataset.slot || s.querySelector('.lbl')?.textContent || '').trim(),
             card_id: cid, serial: ser===''? null : Number(ser) };
  });
}

async function saveFormation(){
  const user_id = $('#user_id').value.trim();
  const name    = $('#fname').value.trim();
  if (!user_id || !name){ alert('user id + formation name required'); return; }
  const shape = $('#shape').value || '4-3-3';
  const slots = collectSlots();
  await callApi('formation_save', { user_id, name, shape, slots });
  alert('Saved âœ”');
}

async function loadFormation(){
  const user_id = $('#user_id').value.trim();
  const name    = $('#fname').value.trim();
  if (!user_id || !name){ alert('enter user id & formation name to load'); return; }
  const data = await callApi('formation_get', { user_id, name });
  if (data?.error){ alert('Not found'); return; }

  $('#shape').value = data.shape || '4-3-3'; relabelForShape();
  // clear all first
  placedSet.clear();
  allSlots().forEach(clearSlot);

  // place cards if present
  (data.slots || []).forEach(s=>{
    const slotEl = allSlots().find(x => String(x.dataset.slot)===String(s.slot_id));
    if (!slotEl || !s.card_id) return;
    // find image from inventory (if not loaded yet, image stays blankâ€”OK)
    const meta = INVENTORY.find(it => it.card_id===s.card_id && String(it.serial ?? '')===String(s.serial ?? ''));
    const img = slotEl.querySelector('.thumb');
    if (img && meta && meta.image) img.src = meta.image;
    slotEl.classList.add('filled');
    slotEl.dataset.cardId = s.card_id;
    slotEl.dataset.serial = (s.serial ?? '');
    slotEl.dataset.kEq = `${s.card_id}::${s.serial ?? ''}`;
    placedSet.add(slotEl.dataset.kEq);
  });

  updatePlacedCount(); markInventoryDim();
}

async function listFormations(){
  const user_id = $('#user_id').value.trim();
  if (!user_id){ alert('enter user id first'); return; }
  const data = await callApi('formation_list', { user_id });
  if (!data.items?.length){ alert('No saved formations'); return; }
  alert('Saved formations:\n' + data.items.map(x=>`${x.name} â€” ${new Date(x.ts).toLocaleString()}`).join('\n'));
}

function clearAll(){
  allSlots().forEach(clearSlot);
  placedSet.clear(); updatePlacedCount(); markInventoryDim();
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // quick prefill via ?u=
  const u = new URLSearchParams(location.search).get('u'); if (u) $('#user_id').value = u;

  attachDnD();
  safeOn('btnSearch','click', loadInventory);
  safeOn('btnRefresh','click', renderInventory);
  safeOn('btnSave','click',    saveFormation);
  safeOn('btnLoad','click',    loadFormation);
  safeOn('btnList','click',    listFormations);
  safeOn('btnClear','click',   clearAll);
  safeOn('shape','change',     relabelForShape);
});
</script>
</body>
</html>
